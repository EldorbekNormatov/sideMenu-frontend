<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fast Capture ‚Äì Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>

  <style>
    body { background:#0f172a; color:white; }
    #overlayCanvas {
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:10;
    }
    #focusRing {
      transition: opacity .2s, transform .2s;
    }
  </style>
</head>

<body>
<div class="max-w-md mx-auto p-4">

  <h2 class="text-xl font-bold mb-4">Fast Capture</h2>

  <div class="flex gap-3 mb-3">
    <button id="startBtn"
      class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition">
      üì∏ Open Camera
    </button>

    <button id="saveAllBtn"
      class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition">
      üíæ Upload All
    </button>
  </div>

  <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

  <div id="cameraBox" class="hidden mt-4 relative">

    <div id="requirementReminder"
      class="absolute top-0 left-0 right-0 p-3 bg-red-800/80 text-white rounded-t-xl z-20 hidden">
      <p class="font-bold text-sm mb-1">‚ö†Ô∏è MUHIM: Avval tekshiring</p>
      <ul class="text-xs ml-4 list-disc">
        <li>Barcha burchaklar ko‚Äòrinsin</li>
        <li>Imzo bor</li>
        <li>Muhr / Stiker bor</li>
      </ul>
    </div>

    <div id="flashOnScreen"
      class="absolute top-3 right-3 bg-yellow-500 px-3 py-1 rounded-full text-xs hidden z-20">
      FLASH
    </div>

    <div id="infoOverlay"
      class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-slate-900/70 px-3 py-1 rounded-full text-xs">
    </div>

    <video id="video" autoplay playsinline
      class="w-full rounded-xl bg-black aspect-[3/4] object-cover"></video>

    <canvas id="overlayCanvas"></canvas>

    <div id="focusRing"
      class="absolute w-20 h-20 rounded-full border-4 border-yellow-300 hidden"
      style="pointer-events:none;"></div>

    <button id="flashBtn"
      class="absolute bottom-20 right-3 bg-yellow-600 p-2 rounded-full hidden active:scale-95 transition text-sm">
      üî¶
    </button>

    <button id="captureBtn"
      class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition">
      üì∑ Capture
    </button>

  </div>

  <h3 class="mt-6 font-bold text-sm">Received Photos</h3>
  <div id="preview" class="space-y-2 mt-2"></div>

</div>

<script>
/* ============= GLOBAL STATE ============= */
let stream = null;
let videoTrack = null;
let images = [];
let torchOn = false;

let lastQuad = null;
let prevQuad = null;
let stableCount = 0;
let autoBusy = false;

const STABLE_FRAMES = 10;
const QUAD_DISTANCE_THR = 40;

/* ============= DOM ============= */
const videoEl = document.getElementById("video");
const overlay = document.getElementById("overlayCanvas");
const octx = overlay.getContext("2d");
const flashBtn = document.getElementById("flashBtn");
const flashBadge = document.getElementById("flashOnScreen");
const previewEl = document.getElementById("preview");
const saveAllBtn = document.getElementById("saveAllBtn");
const infoEl = document.getElementById("infoOverlay");
const statusEl = document.getElementById("status");
const focusRing = document.getElementById("focusRing");
const requirementReminder = document.getElementById("requirementReminder");

/* ============= HELPERS ============= */
function setStatus(msg, type="yellow") {
  statusEl.textContent = msg;
  statusEl.className =
    type === "green" ? "text-green-400" :
    type === "red"   ? "text-red-400"   :
                       "text-yellow-300";
}
function setInfo(msg) {
  infoEl.textContent = msg;
}

function isValidQuad(q) {
  return q && q.length === 4 && q.every(p => p.x > 5 && p.y > 5);
}

function orderQuad(pts) {
  const sum  = pts.map(p => p.x + p.y);
  const diff = pts.map(p => p.y - p.x);
  return [
    pts[sum.indexOf(Math.min(...sum))],   // TL
    pts[diff.indexOf(Math.min(...diff))], // TR
    pts[sum.indexOf(Math.max(...sum))],   // BR
    pts[diff.indexOf(Math.max(...diff))]  // BL
  ];
}

function quadDistance(a, b) {
  if (!a || !b) return Infinity;
  return a.reduce((sum, p, i) =>
    sum + Math.hypot(p.x - b[i].x, p.y - b[i].y)
  , 0);
}

/* ============= FLASH ============= */
async function toggleTorch() {
  if (!videoTrack) return;
  const caps = videoTrack.getCapabilities?.();
  if (!caps?.torch) return;

  torchOn = !torchOn;
  await videoTrack.applyConstraints({ advanced:[{torch:torchOn}] });
}

async function flashBurst() {
  if (!videoTrack) return;
  const caps = videoTrack.getCapabilities?.();
  if (!caps?.torch) return;

  await videoTrack.applyConstraints({ advanced:[{torch:true}] });
  flashBadge.classList.remove("hidden");

  await new Promise(r=>setTimeout(r,250));

  flashBadge.classList.add("hidden");
  await videoTrack.applyConstraints({ advanced:[{torch:torchOn}] });
}

/* ============= CAMERA ============= */
document.getElementById("startBtn").onclick = async () => {
  try {
    setStatus("Opening camera...");
    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ ideal:"environment" },
        width:{ ideal:1920 },
        height:{ ideal:1080 }
      }
    });
  } catch(e) {
    setStatus("‚ùå Camera permission denied","red");
    return;
  }

  videoTrack = stream.getVideoTracks()[0];
  if (videoTrack.getCapabilities?.().torch) flashBtn.classList.remove("hidden");

  videoEl.srcObject = stream;
  document.getElementById("cameraBox").classList.remove("hidden");
  requirementReminder.classList.remove("hidden");

  setStatus("Camera ready","green");

  startDetectionLoop();
};

flashBtn.onclick = toggleTorch;

/* ============= TAP TO FOCUS ============= */
videoEl.addEventListener("click", async (e) => {
  if (!videoTrack) return;

  const rect = videoEl.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  focusRing.style.left = (e.clientX - rect.left - 40)+"px";
  focusRing.style.top  = (e.clientY - rect.top  - 40)+"px";
  focusRing.classList.remove("hidden");
  setTimeout(()=>focusRing.classList.add("hidden"),600);

  await videoTrack.applyConstraints({
    advanced:[{ pointsOfInterest:[{x,y}] }]
  });

  setInfo("üéØ Focus adjusted");
});

/* ============= DETECTION LOOP ============= */
function startDetectionLoop() {
  const temp = document.createElement("canvas");
  const tctx = temp.getContext("2d");

  function step() {
    if (!stream) return;

    const w = videoEl.videoWidth;
    const h = videoEl.videoHeight;
    if (!w || !h) return requestAnimationFrame(step);

    overlay.width = w;
    overlay.height = h;
    temp.width = w;
    temp.height = h;

    tctx.drawImage(videoEl,0,0,w,h);

    if (!window.cv || !cv.Mat) {
      setInfo("‚è≥ AI loading...");
      return requestAnimationFrame(step);
    }

    try {
      const src = cv.imread(temp);
      const gray=new cv.Mat(),blur=new cv.Mat(),edges=new cv.Mat();
      const contours=new cv.MatVector(),hier=new cv.Mat();

      cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);

      const avg = cv.mean(gray)[0];
      cv.Canny(blur,edges,avg*0.5,avg*1.4);

      cv.findContours(edges,contours,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

      octx.clearRect(0,0,w,h);

      let best=null, areaMax=0;

      for (let i=0;i<contours.size();i++){
        const cnt=contours.get(i);
        const peri=cv.arcLength(cnt,true);
        const approx=new cv.Mat();
        cv.approxPolyDP(cnt,approx,peri*0.02,true);

        if (approx.rows===4){
          const area=cv.contourArea(approx);
          if (area>areaMax && area>w*h*0.08){
            areaMax=area;
            if (best) best.delete();
            best=approx;
          } else approx.delete();
        } else approx.delete();
        cnt.delete();
      }

      if (best){
        const pts=[];
        for(let i=0;i<4;i++){
          pts.push({ x:best.intAt(i,0), y:best.intAt(i,1) });
        }
        best.delete();

        lastQuad = orderQuad(pts);

        octx.beginPath();
        octx.moveTo(pts[0].x,pts[0].y);
        octx.lineTo(pts[1].x,pts[1].y);
        octx.lineTo(pts[2].x,pts[2].y);
        octx.lineTo(pts[3].x,pts[3].y);
        octx.closePath();
        octx.lineWidth=3;
        octx.strokeStyle="lime";
        octx.shadowBlur=20;
        octx.stroke();

        setInfo("üìÑ Document detected");

        const dist = quadDistance(lastQuad, prevQuad);
        if (dist < QUAD_DISTANCE_THR) stableCount++;
        else stableCount = 0;

        prevQuad = lastQuad;

        if (stableCount>=STABLE_FRAMES && !autoBusy){
          autoBusy=true;
          setInfo("Stable ‚Üí Auto capture");
          captureAndStore(true).finally(()=>{
            setTimeout(()=>autoBusy=false,1500);
          });
        }

      } else {
        lastQuad=null;
        stableCount=0;
        setInfo("Move closer & show the document");
      }

      src.delete(); gray.delete(); blur.delete();
      edges.delete(); contours.delete(); hier.delete();

    } catch(e){ console.log(e); }

    requestAnimationFrame(step);
  }

  step();
}

/* ============= CAPTURE + CROP ============= */
document.getElementById("captureBtn").onclick = () => captureAndStore(false);

async function captureAndStore(isAuto){
  if (!videoEl.videoWidth) return;

  await flashBurst();

  const base=document.createElement("canvas");
  base.width=videoEl.videoWidth;
  base.height=videoEl.videoHeight;
  base.getContext("2d").drawImage(videoEl,0,0);

  let final=base;

  if (lastQuad && window.cv){
    try {
      const pts=orderQuad(lastQuad);

      const w1=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);
      const w2=Math.hypot(pts[2].x-pts[3].x,pts[2].y-pts[3].y);
      const h1=Math.hypot(pts[3].x-pts[0].x,pts[3].y-pts[0].y);
      const h2=Math.hypot(pts[2].x-pts[1].x,pts[2].y-pts[1].y);

      let dstW=Math.round(Math.max(w1,w2));
      let dstH=Math.round(Math.max(h1,h2));

      const max=1600;
      const scale=Math.min(1, max/Math.max(dstW,dstH));
      dstW=Math.round(dstW*scale);
      dstH=Math.round(dstH*scale);

      const src=cv.imread(base);
      const dst=new cv.Mat();

      const srcTri=cv.matFromArray(4,1,cv.CV_32FC2,[
        pts[0].x,pts[0].y,
        pts[1].x,pts[1].y,
        pts[2].x,pts[2].y,
        pts[3].x,pts[3].y
      ]);

      const dstTri=cv.matFromArray(4,1,cv.CV_32FC2,[
        0,0,
        dstW,0,
        dstW,dstH,
        0,dstH
      ]);

      const M=cv.getPerspectiveTransform(srcTri,dstTri);
      cv.warpPerspective(src,dst,M,new cv.Size(dstW,dstH));

      final=document.createElement("canvas");
      final.width=dstW;
      final.height=dstH;
      cv.imshow(final,dst);

      src.delete(); dst.delete(); srcTri.delete(); dstTri.delete(); M.delete();
    } catch(e){ console.log("crop fail",e); }
  }

  const blob=await new Promise(res=>final.toBlob(res,"image/jpeg",0.95));
  const url=URL.createObjectURL(blob);

  images.push({ blob,url });
  renderImages();

  saveAllBtn.classList.remove("hidden");
  setStatus(isAuto?"Auto captured":"Captured","green");
}

/* ============= PREVIEW ============= */
function renderImages(){
  previewEl.innerHTML="";
  images.forEach((img,i)=>{
    previewEl.innerHTML+=`
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-xl object-contain bg-black" />
        <span class="text-xs opacity-70">Page ${i+1}</span>
        <button data-i="${i}" class="ml-auto bg-red-600 px-2 py-1 rounded-full text-xs">üóë</button>
      </div>`;
  });

  document.querySelectorAll("button[data-i]").forEach(btn=>{
    btn.onclick=()=>{
      const i=btn.dataset.i;
      images.splice(i,1);
      renderImages();
      if (!images.length) saveAllBtn.classList.add("hidden");
    };
  });
}

/* ============= UPLOAD ALL (DEMO) ============= */
saveAllBtn.onclick = () => {
  alert(`Demo: ${images.length} ta skan tayyor!`);
  setStatus("Demo ‚Äî PDF/ZIP uchun backend qo‚Äòshiladi.","green");
};
</script>

</body>
</html>
