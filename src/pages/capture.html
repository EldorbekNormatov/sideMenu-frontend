<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-md mx-auto p-4">
      <h2 class="text-xl font-bold mb-4">Hujjatni rasmga olish</h2>

      <!-- BUTTONS -->
      <div class="flex gap-3 mb-3">
        <button
          id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition"
        >
          ğŸ“¸ Kamerani ochish
        </button>

        <button
          id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition"
        >
          ğŸ’¾ Hamma rasmlarni yuborish
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

      <!-- CAMERA -->
      <div id="camera-box" class="hidden mt-4">
        <video
          id="video"
          autoplay
          playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover"
        ></video>

        <button
          id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition"
        >
          ğŸ“· Rasmni olish
        </button>
      </div>

      <!-- PREVIEW -->
      <h3 class="mt-6 font-bold text-sm">Qabul qilingan rasmlar</h3>
      <div id="preview" class="space-y-2 mt-2"></div>
    </div>

    <script>
      let stream = null;
      let images = []; // backend tasdiqlagan rasmlar {blob,url}

      const statusEl = document.getElementById("status");
      const previewEl = document.getElementById("preview");
      const saveBtn = document.getElementById("saveBtn");

      function setStatus(text, color = "yellow") {
        statusEl.textContent = text;
        statusEl.classList.remove(
          "text-red-400",
          "text-green-400",
          "text-yellow-300"
        );

        if (color === "red") statusEl.classList.add("text-red-400");
        else if (color === "green") statusEl.classList.add("text-green-400");
        else statusEl.classList.add("text-yellow-300");
      }

      /* ========================================================
          KAMERA OCHISH
      ======================================================== */
      document.getElementById("startBtn").onclick = async () => {
        try {
          setStatus("Kamera ochilmoqda...");

          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });

          document.getElementById("video").srcObject = stream;
          document
            .getElementById("camera-box")
            .classList.remove("hidden");

          setStatus("Kamera tayyor. Rasmga oling.", "green");
        } catch (e) {
          console.error(e);
          setStatus("âŒ Kamera ochilmadi", "red");
        }
      };

      /* ========================================================
          CAPTURE â†’ BACKENDGA YUBORISH /photo-check
      ======================================================== */
      document.getElementById("captureBtn").onclick = async () => {
        const video = document.getElementById("video");
        if (!video.videoWidth)
          return setStatus("Kamera tayyor emas", "red");

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        ctx.drawImage(video, 0, 0);

        setStatus("Rasm serverga yuborilyapti...");

        const blob = await new Promise((res) =>
          canvas.toBlob(res, "image/jpeg", 0.9)
        );

        const form = new FormData();
        form.append("photo", blob, "photo.jpg"); // backend: upload.single("photo")

        try {
          const resp = await fetch("http://localhost:4000/photo-check", {
            method: "POST",
            body: form,
          });
          const data = await resp.json();
          console.log("photo-check:", data);

          if (!data.ok) {
            // backend rad etsa
            setStatus(data.msg || "âŒ Rasm yaroqsiz", "red");
            return;
          }

          // backend tasdiqladi â†’ rasmni roâ€˜yxatga qoâ€˜shamiz
          const url = URL.createObjectURL(blob);
          images.push({ blob, url });

          renderImages();
          saveBtn.classList.remove("hidden");

          setStatus(
            "âœ” Rasm qabul qilindi! Keyingi rasmni olishingiz mumkin.",
            "green"
          );
        } catch (err) {
          console.error(err);
          setStatus("âŒ Server bilan aloqa yoâ€˜q", "red");
        }
      };

      /* ========================================================
          PREVIEW RASMLAR
      ======================================================== */
      function renderImages() {
        previewEl.innerHTML = "";

        images.forEach((img, i) => {
          previewEl.innerHTML += `
          <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
            <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
            <button data-i="${i}"
                    class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">ğŸ—‘ O'chirish</button>
          </div>
        `;
        });

        document.querySelectorAll("button[data-i]").forEach((btn) => {
          btn.onclick = () => {
            images.splice(btn.dataset.i, 1);
            renderImages();
            if (images.length === 0) {
              saveBtn.classList.add("hidden");
            }
          };
        });
      }

      /* ========================================================
          OXIRIDA: BARCHA RASMLARNI BOSHQA ROUTE GA YUBORISH
          POST /submit-documents   (backendda oâ€˜zing yozasan)
      ======================================================== */
      saveBtn.onclick = async () => {
        if (images.length === 0)
          return setStatus("Avval kamida bitta rasm oling", "red");

        setStatus("Hamma rasmlar yuborilyapti...");

        const form = new FormData();
        images.forEach((img, i) => {
          form.append("photos", img.blob, `photo_${i}.jpg`);
        });

        try {
          const resp = await fetch(
            "http://localhost:4000/submit-documents",
            {
              method: "POST",
              body: form,
            }
          );
          const data = await resp.json();
          console.log("submit-documents:", data);

          if (data.ok) {
            setStatus("âœ” Hamma rasm muvaffaqiyatli yuborildi!", "green");
            images = [];
            renderImages();
            saveBtn.classList.add("hidden");
          } else {
            setStatus(data.msg || "âŒ Yuborishda xatolik", "red");
          }
        } catch (e) {
          console.error(e);
          setStatus("âŒ Server bilan aloqa yoâ€˜q", "red");
        }
      };
    </script>
  </body>
</html>
