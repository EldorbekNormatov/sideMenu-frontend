<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-md mx-auto p-4">
      <h2 class="text-xl font-bold mb-4">Hujjatni rasmga olish</h2>

      <!-- BUTTONS -->
      <div class="flex gap-3 mb-3">
        <button id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition">
          ğŸ“¸ Kamerani ochish
        </button>

        <button id="flashBtn"
          class="flex-1 bg-yellow-600 p-3 rounded-full hidden active:scale-95 transition">
          ğŸ”¦ Yorug'lik
        </button>

        <button id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition">
          ğŸ’¾ Hamma rasmlarni yuborish
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

      <!-- CAMERA -->
      <div id="camera-box" class="hidden mt-4">
        <video id="video" autoplay playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover"></video>

        <button id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition">
          ğŸ“· Rasmni olish
        </button>
      </div>

      <!-- PREVIEW -->
      <h3 class="mt-6 font-bold text-sm">Qabul qilingan rasmlar</h3>
      <div id="preview" class="space-y-2 mt-2"></div>
    </div>

<script>
/* ===========================
   URL â†’ UID â†’ LOCALSTORAGE
=========================== */
const params = new URLSearchParams(window.location.search);
const uidFromUrl = params.get("uid");

if (uidFromUrl) {
  localStorage.setItem("driver_uid", uidFromUrl);
  console.log("UID saqlandi:", uidFromUrl);
}

const DRIVER_UID = localStorage.getItem("driver_uid") || "";
const API = "https://panel.nvmailer.uz";  

let stream = null;
let images = []; 
let videoTrack = null;
let torchOn = false;

const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");

function setStatus(text, color="yellow") {
  statusEl.textContent = text;
  statusEl.className =
    color === "red" ? "text-red-400 text-xs" :
    color === "green" ? "text-green-400 text-xs" :
    "text-yellow-300 text-xs";
}

/* ===========================
      FLASH ON/OFF
=========================== */
async function toggleTorch() {
  if (!videoTrack) return;

  const capabilities = videoTrack.getCapabilities();
  if (!capabilities.torch) {
    setStatus("âš  Torch qoâ€˜llanmaydi", "yellow");
    return;
  }

  torchOn = !torchOn;

  try {
    await videoTrack.applyConstraints({
      advanced: [{ torch: torchOn }]
    });
    document.getElementById("flashBtn").textContent =
      torchOn ? "ğŸ”¦ Oâ€˜chirish" : "ğŸ”¦ Yorug'lik";
  } catch (err) {
    console.error(err);
    setStatus("Torch ishlamadi", "red");
  }
}

/* ===========================
      KAMERA OCHISH
=========================== */
document.getElementById("startBtn").onclick = async () => {
  try {
    setStatus("Kamera ochilmoqda...");

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        focusMode: "continuous"
      }
    });

    videoTrack = stream.getVideoTracks()[0];
    const caps = videoTrack.getCapabilities();

    // Autofocus qoâ€˜yiladi
    if (caps.focusMode) {
      await videoTrack.applyConstraints({
        advanced: [{ focusMode: "continuous" }]
      });
    }

    // Torch qoâ€˜llasa, flash tugmasi koâ€˜rsatiladi
    if (caps.torch) {
      document.getElementById("flashBtn").classList.remove("hidden");
    }

    document.getElementById("video").srcObject = stream;
    document.getElementById("camera-box").classList.remove("hidden");

    setStatus("Kamera tayyor. Rasmga oling.", "green");

  } catch (e) {
    console.error(e);
    setStatus("âŒ Kamera ochilmadi", "red");
  }
};

document.getElementById("flashBtn").onclick = toggleTorch;

/* ===========================
   CAPTURE â†’ /photo-check
=========================== */
document.getElementById("captureBtn").onclick = async () => {
  const video = document.getElementById("video");
  if (!video.videoWidth) return setStatus("Kamera tayyor emas", "red");

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  /* QORONG'U ANIQLASH â†’ Torch yoqish */
  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let sum = 0;

  for (let i = 0; i < frame.data.length; i += 4) {
    sum += frame.data[i]; // red kanal
  }

  const avg = sum / (frame.data.length / 4);

  if (avg < 50 && videoTrack.getCapabilities().torch && !torchOn) {
    toggleTorch();
    setStatus("Qorong'u â†’ Torch yoqildi", "yellow");
  }

  setStatus("Rasm serverga yuborilyapti...");

  const blob = await new Promise(res =>
    canvas.toBlob(res, "image/jpeg", 0.9)
  );

  const form = new FormData();
  form.append("photo", blob, "photo.jpg");
  form.append("uid", DRIVER_UID);

  try {
    const resp = await fetch(`${API}/photo-check`, { method: "POST", body: form });
    const data = await resp.json();

    if (!data.ok) {
      setStatus(data.msg || "âŒ Rasm yaroqsiz", "red");
      return;
    }

    const url = URL.createObjectURL(blob);
    images.push({ blob, url });

    renderImages();
    saveBtn.classList.remove("hidden");

    setStatus("âœ” Rasm qabul qilindi! Keyingisini oling.", "green");

  } catch (err) {
    console.error(err);
    setStatus("âŒ Server bilan aloqa yoâ€˜q", "red");
  }
};

/* ===========================
      PREVIEW RASMLAR
=========================== */
function renderImages() {
  previewEl.innerHTML = "";

  images.forEach((img, i) => {
    previewEl.innerHTML += `
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
        <button data-i="${i}" class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">
          ğŸ—‘ O'chirish
        </button>
      </div>
    `;
  });

  document.querySelectorAll("button[data-i]").forEach(btn => {
    btn.onclick = () => {
      images.splice(btn.dataset.i, 1);
      renderImages();
      if (images.length === 0) saveBtn.classList.add("hidden");
    };
  });
}

/* ===========================
   ALL PHOTOS â†’ /photo-save
=========================== */
saveBtn.onclick = async () => {
  if (images.length === 0)
    return setStatus("Avval kamida bitta rasm oling", "red");

  setStatus("Hamma rasmlar yuborilyapti...");

  const form = new FormData();
  images.forEach((img, i) => {
    form.append("photos", img.blob, `photo_${i}.jpg`);
  });

  form.append("uid", DRIVER_UID);

  try {
    const resp = await fetch(`${API}/photo-save`, { method: "POST", body: form });
    const data = await resp.json();

    if (data.ok) {
      setStatus("âœ” Hamma rasm yuborildi!", "green");
      images = [];
      renderImages();
      saveBtn.classList.add("hidden");
    } else {
      setStatus(data.msg || "âŒ Yuborishda xatolik", "red");
    }

  } catch (e) {
    console.error(e);
    setStatus("âŒ Server bilan aloqa yoâ€˜q", "red");
  }
};
</script>

  </body>
</html>
