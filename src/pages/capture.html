<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A4 Scanner â€” Highlight Edition</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <style>
    .video-box { aspect-ratio: 3/4; object-fit: cover; border-radius: 12px; }
    .overlay-canvas { position: absolute; inset: 0; pointer-events: none; }
    .focus-ring {
      position: absolute;
      width: 80px; height: 80px;
      border: 4px solid #fbbf24;
      border-radius: 9999px;
      display: none;
      pointer-events: none;
      transform: translate(-50%,-50%);
    }
  </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex justify-center py-8">

<div class="w-full max-w-md px-4">
  <h1 class="text-xl font-bold mb-4">ðŸ“„ A4 Scanner (Live Highlight)</h1>

  <div class="flex gap-3 mb-3">
    <button id="startBtn" class="flex-1 bg-slate-700 py-3 rounded-full">ðŸ“¸ Open Camera</button>
  </div>

  <p id="status" class="text-xs text-yellow-300 min-h-[20px]"></p>

  <!-- CAMERA BOX -->
  <div id="camera-box" class="relative hidden">

    <div id="infoOverlay"
         class="absolute left-1/2 -translate-x-1/2 bottom-3 bg-black/60 px-3 py-1 rounded-full text-xs z-20"></div>

    <video id="video" autoplay playsinline class="w-full bg-black video-box"></video>

    <canvas id="overlay" class="overlay-canvas z-10"></canvas>

    <div id="focusRing" class="focus-ring z-30"></div>

  </div>
</div>

<script>
/* ====================== CONFIG ====================== */
let stream = null;
let videoTrack = null;
let cvReady = false;
let lastQuad = null;

/* ====================== DOM ========================= */
const videoEl = document.getElementById("video");
const startBtn = document.getElementById("startBtn");
const cameraBox = document.getElementById("camera-box");
const statusEl = document.getElementById("status");
const overlay = document.getElementById("overlay");
const overlayCtx = overlay.getContext("2d");
const infoOverlay = document.getElementById("infoOverlay");

/* ====================== HELPERS ===================== */
function setStatus(t,c="yellow"){
  statusEl.textContent=t;
  statusEl.className =
      c==="green"?"text-green-400 text-xs":
      c==="red"?"text-red-400 text-xs":
      "text-yellow-300 text-xs";
}
function setInfo(t=""){ infoOverlay.textContent=t; }

/* Wait OpenCV */
(function(){
  const timer=setInterval(()=>{
    if(window.cv && cv.Mat){
      cv.onRuntimeInitialized = ()=>{
        cvReady=true;
        setStatus("OpenCV loaded","green");
      };
      clearInterval(timer);
    }
  },120);
})();

/* ====================== ORDER QUAD ================== */
function orderQuad(pts){
  const sum=pts.map(p=>p.x+p.y);
  const diff=pts.map(p=>p.y-p.x);
  return [
    pts[sum.indexOf(Math.min(...sum))],   // top-left
    pts[diff.indexOf(Math.min(...diff))], // top-right
    pts[sum.indexOf(Math.max(...sum))],   // bottom-right
    pts[diff.indexOf(Math.max(...diff))]  // bottom-left
  ];
}
function isValidQuad(q){
  if(!q||q.length!==4) return false;
  return q.every(p=>p.x>3 && p.y>3);
}

/* ====================== CAMERA ====================== */
startBtn.onclick = async () => {
  try{
    setStatus("Opening camera...");
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment", width:{ideal:1920}, height:{ideal:1080}}
    });

    videoTrack = stream.getVideoTracks()[0];
    videoEl.srcObject = stream;

    cameraBox.classList.remove("hidden");
    setStatus("Camera ready","green");

    startDetectionLoop();

  }catch(e){
    console.error(e);
    setStatus("Camera error","red");
  }
};

/* ====================== DETECTION LOOP ============== */
function startDetectionLoop(){

  const detectCanvas=document.createElement("canvas");
  const dctx=detectCanvas.getContext("2d");

  function step(){
    if(!stream) return;
    if(!cvReady || !videoEl.videoWidth){
      requestAnimationFrame(step);
      return;
    }

    const w = videoEl.videoWidth;
    const h = videoEl.videoHeight;

    detectCanvas.width=w;
    detectCanvas.height=h;
    overlay.width=w;
    overlay.height=h;

    dctx.drawImage(videoEl,0,0,w,h);

    let src = cv.imread(detectCanvas);
    let gray = new cv.Mat();
    let blur = new cv.Mat();
    let edges = new cv.Mat();
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();

    cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);
    cv.Canny(blur,edges,60,180);
    cv.findContours(edges,contours,hierarchy,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE);

    overlayCtx.clearRect(0,0,w,h);

    let bestArea=0, bestQuad=null;

    for(let i=0;i<contours.size();i++){
      const cnt=contours.get(i);
      const peri=cv.arcLength(cnt,true);
      const approx=new cv.Mat();
      cv.approxPolyDP(cnt,approx,peri*0.02,true);

      if(approx.rows===4){
        const area=cv.contourArea(approx);
        if(area>bestArea){
          bestArea=area;
          if(bestQuad) bestQuad.delete();
          bestQuad=approx;
        }else approx.delete();
      }else approx.delete();

      cnt.delete();
    }

    if(bestQuad && bestArea> w*h*0.12){
      const pts=[];
      for(let i=0;i<4;i++)
        pts.push({x:bestQuad.intAt(i,0), y:bestQuad.intAt(i,1)});

      lastQuad = orderQuad(pts);

      /* -------------------------------
         â­ DRAW YELLOW HIGHLIGHT
         -------------------------------*/
      overlayCtx.clearRect(0,0,w,h);

      // 1. Qora yarim shaffof mask
      overlayCtx.fillStyle="rgba(0,0,0,0.55)";
      overlayCtx.fillRect(0,0,w,h);

      // 2. Polygon path â€” document area
      overlayCtx.save();
      overlayCtx.beginPath();
      overlayCtx.moveTo(lastQuad[0].x, lastQuad[0].y);
      overlayCtx.lineTo(lastQuad[1].x, lastQuad[1].y);
      overlayCtx.lineTo(lastQuad[2].x, lastQuad[2].y);
      overlayCtx.lineTo(lastQuad[3].x, lastQuad[3].y);
      overlayCtx.closePath();

      // 3. Cut-out the polygon (transparent)
      overlayCtx.globalCompositeOperation="destination-out";
      overlayCtx.fill();
      overlayCtx.restore();

      // 4. Now overlay yellow transparent highlight
      overlayCtx.fillStyle="rgba(255,220,0,0.35)";
      overlayCtx.beginPath();
      overlayCtx.moveTo(lastQuad[0].x, lastQuad[0].y);
      overlayCtx.lineTo(lastQuad[1].x, lastQuad[1].y);
      overlayCtx.lineTo(lastQuad[2].x, lastQuad[2].y);
      overlayCtx.lineTo(lastQuad[3].x, lastQuad[3].y);
      overlayCtx.closePath();
      overlayCtx.fill();

      // 5. Bold yellow border
      overlayCtx.lineWidth=4;
      overlayCtx.strokeStyle="rgb(255,200,0)";
      overlayCtx.beginPath();
      overlayCtx.moveTo(lastQuad[0].x, lastQuad[0].y);
      overlayCtx.lineTo(lastQuad[1].x, lastQuad[1].y);
      overlayCtx.lineTo(lastQuad[2].x, lastQuad[2].y);
      overlayCtx.lineTo(lastQuad[3].x, lastQuad[3].y);
      overlayCtx.closePath();
      overlayCtx.stroke();

      setInfo("ðŸ“„ Hujjat topildi â€” toâ€˜gâ€˜rilang");

    } else {
      lastQuad=null;
      overlayCtx.clearRect(0,0,w,h);
      setInfo("Hujjatni toâ€˜liq koâ€˜rsating");
    }

    src.delete(); gray.delete(); blur.delete();
    edges.delete(); contours.delete(); hierarchy.delete();
    if(bestQuad) bestQuad.delete();

    requestAnimationFrame(step);
  }

  step();
}
</script>
</body>
</html>
