<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

    <!-- CLICK SOUND -->
    <audio id="clickSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <style>
      /* BORDER PULSE ANIMATION */
      @keyframes pulseGreen {
        0%   { box-shadow: 0 0 0px 0px rgba(0,255,0,0.7); }
        50%  { box-shadow: 0 0 30px 10px rgba(0,255,0,1); }
        100% { box-shadow: 0 0 0px 0px rgba(0,255,0,0.7); }
      }
      .pulse-green {
        animation: pulseGreen 0.6s ease-out;
      }
    </style>
  </head>

<body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-md mx-auto p-4">
      <h2 class="text-xl font-bold mb-4">Take Document Photo</h2>

      <div class="flex gap-3 mb-3">
        <button id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full">
          ðŸ“¸ Open Camera
        </button>

        <button id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden">
          ðŸ’¾ Upload All Photos
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

      <div id="camera-box" class="hidden mt-4 relative">

        <div id="infoOverlay"
          class="absolute left-1/2 -translate-x-1/2 bottom-3 bg-slate-900/70 px-3 py-1 
          rounded-full text-xs z-20"></div>

        <video id="video" autoplay playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover"></video>

        <canvas id="overlay"
          class="absolute inset-0 w-full h-full pointer-events-none z-10"></canvas>

        <button id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full hidden">
          ðŸ“· Capture Photo
        </button>
      </div>

      <h3 class="mt-6 font-bold text-sm">Received Photos</h3>
      <div id="preview" class="space-y-2 mt-2"></div>
    </div>

<script>
/* =========================== GLOBAL VARIABLES =========================== */
let stream = null;
let videoTrack = null;
let images = [];
let torchOn = false;

let cvReady = false;
let lastQuad = null;

/* AUTO CAPTURE */
let prevQuad = null;
let stableCount = 0;
let captureCooldown = false;

/* DOM */
const clickSound = document.getElementById("clickSound");
const overlayCanvas = document.getElementById("overlay");
const overlayCtx = overlayCanvas.getContext("2d");
const infoOverlay = document.getElementById("infoOverlay");
const saveBtn = document.getElementById("saveBtn");
const previewEl = document.getElementById("preview");

/* ================= OPEN CV LOAD ================= */
(function waitForCV() {
  const chk = setInterval(() => {
    if (window.cv && cv.Mat) {
      cv.onRuntimeInitialized = () => cvReady = true;
      clearInterval(chk);
    }
  }, 100);
})();

/* ================= STATUS TEXT ================= */
function setInfo(text) { infoOverlay.textContent = text; }

/* ================= QUAD CHECK ================= */
function isSameQuad(q1, q2) {
  if (!q1 || !q2) return false;
  let diff = 0;
  for (let i = 0; i < 4; i++)
    diff += Math.hypot(q1[i].x - q2[i].x, q1[i].y - q2[i].y);
  return diff < 30;
}

/* ================= AUTO CAPTURE ================= */
async function triggerAutoCapture() {
  if (captureCooldown) return;
  captureCooldown = true;

  clickSound.play();               // ðŸ”Š CLICK SOUND
  overlayCanvas.classList.add("pulse-green"); // ðŸŒˆ ANIMATION

  document.getElementById("captureBtn").click();

  setTimeout(() => {
    captureCooldown = false;
    overlayCanvas.classList.remove("pulse-green");
  }, 1000);
}

/* ================= DETECTION LOOP ================= */
function startDetectionLoop() {
  const video = document.getElementById("video");
  const tmp = document.createElement("canvas");
  const tmpCtx = tmp.getContext("2d");

  function step() {
    if (!cvReady || !video.videoWidth) return requestAnimationFrame(step);

    const w = video.videoWidth;
    const h = video.videoHeight;
    tmp.width = w;
    tmp.height = h;
    overlayCanvas.width = w;
    overlayCanvas.height = h;

    tmpCtx.drawImage(video, 0, 0, w, h);

    let src = cv.imread(tmp);
    let gray = new cv.Mat();
    let blur = new cv.Mat();
    let edges = new cv.Mat();
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();

    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, blur, new cv.Size(7,7), 0);
    cv.Canny(blur, edges, 50, 150);
    cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    overlayCtx.clearRect(0, 0, w, h);

    let best = null;
    let maxArea = 0;

    for (let i = 0; i < contours.size(); i++) {
      let cnt = contours.get(i);
      let peri = cv.arcLength(cnt, true);
      let approx = new cv.Mat();
      cv.approxPolyDP(cnt, approx, peri * 0.02, true);

      if (approx.rows === 4) {
        let area = cv.contourArea(cnt);
        if (area > maxArea) {
          maxArea = area;
          if (best) best.delete();
          best = approx;
        }
      } else approx.delete();
      cnt.delete();
    }

    if (best && maxArea > (w*h*0.12)) {
      let pts = [];
      for (let i = 0; i < 4; i++) {
        pts.push({ x: best.intAt(i,0), y: best.intAt(i,1) });
      }
      lastQuad = pts;

      overlayCtx.beginPath();
      overlayCtx.moveTo(pts[0].x, pts[0].y);
      overlayCtx.lineTo(pts[1].x, pts[1].y);
      overlayCtx.lineTo(pts[2].x, pts[2].y);
      overlayCtx.lineTo(pts[3].x, pts[3].y);
      overlayCtx.closePath();

      overlayCtx.lineWidth = 4;
      overlayCtx.strokeStyle = "lime";
      overlayCtx.stroke();

      setInfo("ðŸ“„ Document detected");

      if (isSameQuad(prevQuad, pts)) stableCount++;
      else stableCount = 0;

      prevQuad = pts;

      if (stableCount > 10 && !captureCooldown) triggerAutoCapture();
    }
    else {
      setInfo("Searching document...");
      lastQuad = null;
      stableCount = 0;
      prevQuad = null;
    }

    src.delete(), gray.delete(), blur.delete();
    edges.delete(), contours.delete(), hierarchy.delete();

    requestAnimationFrame(step);
  }
  step();
}

/* ================= CAPTURE BUTTON ================= */
document.getElementById("captureBtn").onclick = async () => {
  const video = document.getElementById("video");

  const base = document.createElement("canvas");
  base.width = video.videoWidth;
  base.height = video.videoHeight;
  base.getContext("2d").drawImage(video, 0, 0);

  let finalCanvas = base;

  if (lastQuad && cvReady) {
    let pts = lastQuad;
    let w1 = Math.hypot(pts[1].x-pts[0].x, pts[1].y-pts[0].y);
    let w2 = Math.hypot(pts[2].x-pts[3].x, pts[2].y-pts[3].y);
    let h1 = Math.hypot(pts[3].x-pts[0].x, pts[3].y-pts[0].y);
    let h2 = Math.hypot(pts[2].x-pts[1].x, pts[2].y-pts[1].y);

    let dstW = Math.max(w1, w2);
    let dstH = Math.max(h1, h2);

    let src = cv.imread(base);
    let dst = new cv.Mat();

    let srcTri = cv.matFromArray(4,1,cv.CV_32FC2,[
      pts[0].x,pts[0].y, pts[1].x,pts[1].y,
      pts[2].x,pts[2].y, pts[3].x,pts[3].y
    ]);

    let dstTri = cv.matFromArray(4,1,cv.CV_32FC2,[
      0,0, dstW,0, dstW,dstH, 0,dstH
    ]);

    let M = cv.getPerspectiveTransform(srcTri, dstTri);
    cv.warpPerspective(src, dst, M, new cv.Size(dstW, dstH));

    finalCanvas = document.createElement("canvas");
    finalCanvas.width = dstW;
    finalCanvas.height = dstH;
    cv.imshow(finalCanvas, dst);
  }

  const blob = await new Promise(r => finalCanvas.toBlob(r));
  const url = URL.createObjectURL(blob);

  images.push({ blob, url });
  saveBtn.classList.remove("hidden");
  renderImages();
};

/* ================= PREVIEW RENDER ================= */
function renderImages() {
  previewEl.innerHTML = "";
  images.forEach((img, i) => {
    previewEl.innerHTML += `
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
        <button data-i="${i}" class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">ðŸ—‘ Delete</button>
      </div>
    `;
  });

  document.querySelectorAll("button[data-i]").forEach(btn =>
    btn.onclick = () => { images.splice(btn.dataset.i,1); renderImages(); }
  );
}

/* ================= OPEN CAMERA ================= */
document.getElementById("startBtn").onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  document.getElementById("video").srcObject = stream;
  document.getElementById("camera-box").classList.remove("hidden");

  startDetectionLoop();
};
</script>

</body>
</html>
