<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Document Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-md mx-auto p-4 pb-10">
      <h2 class="text-xl font-bold mb-2">Hujjatni rasmga olish</h2>
      <p class="text-xs text-slate-300 mb-4">
        Hujjatni kadrlang, telefonni tekis tuting va qimirlatmang.
        Shartlar bajarilganda rasm avtomatik olinadi.
      </p>

      <!-- BUTTONS -->
      <div class="flex gap-3 mb-3">
        <button
          id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition"
        >
          ðŸ“¸ Kamerani ochish
        </button>

        <button
          id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition"
        >
          ðŸ’¾ Yuborish
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300 mb-1"></p>

      <!-- CAMERA -->
      <div
        id="camera-box"
        class="hidden mt-3 relative rounded-xl overflow-hidden"
      >
        <!-- Overlay message -->
        <div
          id="overlayMsg"
          class="absolute top-2 left-1/2 -translate-x-1/2 text-[10px] px-3 py-1 rounded-full bg-black/70 z-20 hidden"
        ></div>

        <!-- Guide box -->
        <div
          id="guideBox"
          class="absolute inset-[8%] border-2 border-red-500/70 rounded-xl z-10 pointer-events-none hidden"
        ></div>

        <video
          id="video"
          autoplay
          playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover"
        ></video>

        <button
          id="newDocBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition"
        >
          âž• Yana hujjat qoâ€˜yish
        </button>
      </div>

      <!-- PREVIEW -->
      <h3 class="mt-6 font-bold text-sm">Olingan rasmlar</h3>
      <div id="preview" class="space-y-2 mt-2"></div>
    </div>

    <script>
      /* ================= GLOBAL STATE ================= */
      let stream = null;
      let images = [];

      const statusEl = document.getElementById("status");
      const previewEl = document.getElementById("preview");
      const saveBtn = document.getElementById("saveBtn");
      const videoEl = document.getElementById("video");
      const guideBox = document.getElementById("guideBox");
      const overlayMsg = document.getElementById("overlayMsg");

      let cvReady = false;
      let liveTimer = null;
      let lastFrameData = null;
      let isCapturing = false;
      let lastCaptureTime = 0;

      function setStatus(text, color = "yellow") {
        statusEl.textContent = text;
        statusEl.classList.remove(
          "text-red-400",
          "text-green-400",
          "text-yellow-300"
        );

        if (color === "red") statusEl.classList.add("text-red-400");
        else if (color === "green") statusEl.classList.add("text-green-400");
        else statusEl.classList.add("text-yellow-300");
      }

      function showOverlay(text, color = "red") {
        overlayMsg.textContent = text;
        overlayMsg.classList.remove("hidden");
        overlayMsg.classList.remove("bg-red-600/80", "bg-emerald-600/80");

        if (color === "green") {
          overlayMsg.classList.add("bg-emerald-600/80");
        } else {
          overlayMsg.classList.add("bg-red-600/80");
        }
      }

      function hideOverlay() {
        overlayMsg.classList.add("hidden");
      }

      /* ================= OpenCV READY ================= */
      window.Module = {
        onRuntimeInitialized() {
          cvReady = true;
          setStatus("âœ… OpenCV tayyor. Kamerani oching.", "green");
        },
      };

      /* ================= CAMERA START ================= */
      document.getElementById("startBtn").onclick = async () => {
        if (!cvReady)
          return setStatus("â³ OpenCV yuklanmoqda. Bir necha soniya kuting.", "yellow");

        try {
          setStatus("Kamera ochilmoqda...");

          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });

          videoEl.srcObject = stream;
          document.getElementById("camera-box").classList.remove("hidden");

          setStatus(
            "Kamera tayyor. Hujjatni kadrlang va qimirlatmang. Avtomatik rasmga olinadi.",
            "green"
          );

          guideBox.classList.remove("hidden");
          startLiveDetection();
        } catch (e) {
          console.error(e);
          setStatus("âŒ Kamera ochilmadi", "red");
        }
      };

      /* ================= NEW DOC BUTTON ================= */
      document.getElementById("newDocBtn").onclick = () => {
        lastFrameData = null;
        lastCaptureTime = 0;
        isCapturing = false;
        setStatus(
          "Yangi hujjat uchun: hujjatni kadrlang va qimirlatmang. Avtomatik rasmga olinadi.",
          "yellow"
        );
      };

      /* ================= LIVE DETECTION LOOP ================= */
      function startLiveDetection() {
        if (liveTimer) clearInterval(liveTimer);

        liveTimer = setInterval(async () => {
          if (!videoEl.videoWidth || !cvReady) return;

          const canvas = document.createElement("canvas");
          canvas.width = videoEl.videoWidth;
          canvas.height = videoEl.videoHeight;
          const ctx = canvas.getContext("2d", { willReadFrequently: true });
          ctx.drawImage(videoEl, 0, 0);

          // Stability
          const stable = isStable(canvas);

          // Strict document detection
          const doc = await detectDocumentStrict(canvas);

          // Hand detection
          const hasHand = detectHand(canvas);

          // UI updates
          if (!doc.ok) {
            guideBox.style.borderColor = "rgba(239,68,68,0.8)"; // red
            showOverlay("Hujjatni toâ€˜liq kadrlang", "red");
          } else if (!stable) {
            guideBox.style.borderColor = "rgba(251,191,36,0.8)"; // yellow
            showOverlay("Telefonni qimirlatmang", "red");
          } else if (hasHand) {
            guideBox.style.borderColor = "rgba(251,191,36,0.8)";
            showOverlay("Qoâ€˜lni hujjatdan ozgina chetga oling", "red");
          } else {
            guideBox.style.borderColor = "rgba(16,185,129,0.9)"; // green
            showOverlay("Hamma narsa yaxshi, rasm olinmoqda...", "green");
          }

          // All good? â†’ auto capture
          if (doc.ok && stable && !hasHand) {
            autoCapture(canvas);
          }
        }, 400);
      }

      /* ================= AUTO CAPTURE ================= */
      async function autoCapture(canvasFromLoop) {
        if (isCapturing) return;
        const now = Date.now();
        if (now - lastCaptureTime < 2000) return; // 2s debounce

        isCapturing = true;

        try {
          // To capture full quality: qayta full canvas olib check qilamiz
          const fullCanvas = document.createElement("canvas");
          fullCanvas.width = videoEl.videoWidth;
          fullCanvas.height = videoEl.videoHeight;
          fullCanvas
            .getContext("2d", { willReadFrequently: true })
            .drawImage(videoEl, 0, 0);

          // Blur test
          const blurry = await isBlur(fullCanvas);
          if (blurry) {
            setStatus("âŒ Rasm xira. Fokus qilib yana urinib koâ€˜ring.", "red");
            isCapturing = false;
            return;
          }

          // Lighting test
          const lighting = await isLightingBad(fullCanvas);
          if (lighting === "dark") {
            setStatus("âŒ Juda qorongâ€˜i. Yorugâ€˜ joyga oling.", "red");
            isCapturing = false;
            return;
          }
          if (lighting === "bright") {
            setStatus("âŒ Juda yorugâ€˜. Soyaga oling.", "red");
            isCapturing = false;
            return;
          }

          // Strict document tekshiruvi yana
          const docStrict = await detectDocumentStrict(fullCanvas);
          if (!docStrict.ok) {
            setStatus("âŒ Hujjat shakli toâ€˜liq aniqlanmadi.", "red");
            isCapturing = false;
            return;
          }

          // Hand check again
          if (detectHand(fullCanvas)) {
            setStatus("âŒ Qoâ€˜l hujjatni toâ€˜sib turibdi.", "red");
            isCapturing = false;
            return;
          }

          // SUCCESS â†’ save image
          const blob = await new Promise((res) =>
            fullCanvas.toBlob(res, "image/jpeg", 0.9)
          );
          const url = URL.createObjectURL(blob);

          images.push({ blob, url });
          renderImages();

          saveBtn.classList.remove("hidden");
          lastCaptureTime = Date.now();
          setStatus("âœ… Hujjat muvaffaqiyatli olindi.", "green");
          showOverlay("âœ… Rasm olindi. Agar xohlasangiz yangi hujjat qoâ€˜ying.", "green");
        } catch (e) {
          console.error(e);
          setStatus("âŒ Rasmni olishda xatolik yuz berdi.", "red");
        } finally {
          isCapturing = false;
        }
      }

      /* ================= BLUR DETECTOR ================= */
      async function isBlur(canvas, threshold = 70) {
        return new Promise((res) => {
          const scale = 200 / Math.max(canvas.width, canvas.height);
          const w = canvas.width * scale;
          const h = canvas.height * scale;

          const c = document.createElement("canvas");
          c.width = w;
          c.height = h;

          const ctx = c.getContext("2d", { willReadFrequently: true });
          ctx.drawImage(canvas, 0, 0, w, h);

          const { data } = ctx.getImageData(0, 0, w, h);

          let sum = 0,
            sq = 0;
          for (let i = 0; i < data.length; i += 4) {
            const g = (data[i] + data[i + 1] + data[i + 2]) / 3;
            sum += g;
            sq += g * g;
          }

          const n = data.length / 4;
          const variance = sq / n - (sum / n) ** 2;

          res(variance < threshold);
        });
      }

      /* ================= LIGHTING DETECTOR ================= */
      async function isLightingBad(canvas) {
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);

        let sum = 0,
          n = data.length / 4;

        for (let i = 0; i < data.length; i += 4) {
          const b = (data[i] + data[i + 1] + data[i + 2]) / 3;
          sum += b;
        }

        const avg = sum / n;

        if (avg < 50) return "dark";
        if (avg > 210) return "bright";
        return "ok";
      }

      /* ================= DOCUMENT DETECTION (OpenCV) ================= */
      async function detectDocumentStrict(canvas) {
        return new Promise((resolve) => {
          try {
            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            let blurred = new cv.Mat();
            let edges = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
            cv.Canny(blurred, edges, 75, 150);

            cv.findContours(
              edges,
              contours,
              hierarchy,
              cv.RETR_LIST,
              cv.CHAIN_APPROX_SIMPLE
            );

            let best = null;
            let bestArea = 0;
            let bestApprox = null;

            const imgArea = canvas.width * canvas.height;

            for (let i = 0; i < contours.size(); i++) {
              let cnt = contours.get(i);
              let peri = cv.arcLength(cnt, true);
              let approx = new cv.Mat();

              cv.approxPolyDP(cnt, approx, 0.015 * peri, true);

              if (approx.rows < 4 || approx.rows > 6) {
                approx.delete();
                continue;
              }

              let area = cv.contourArea(cnt);

              if (area > imgArea * 0.2 && area < imgArea * 0.9) {
                if (area > bestArea) {
                  best = cnt;
                  bestArea = area;
                  if (bestApprox) bestApprox.delete();
                  bestApprox = approx;
                } else {
                  approx.delete();
                }
              } else {
                approx.delete();
              }
            }

            if (!best || !bestApprox) {
              cleanup();
              return resolve({ ok: false });
            }

            let corners = [];
            for (let i = 0; i < bestApprox.rows; i++) {
              const x = bestApprox.intPtr(i, 0)[0];
              const y = bestApprox.intPtr(i, 0)[1];
              corners.push({ x, y });
            }

            const ratio = getDocumentRatio(corners, canvas.width, canvas.height);
            if (ratio < 0.6 || ratio > 1.9) {
              cleanup();
              return resolve({ ok: false });
            }

            const skew = getDocumentSkew(corners);
            if (Math.abs(skew) > 14) {
              cleanup();
              return resolve({ ok: false, reason: "skew" });
            }

            cleanup();
            resolve({ ok: true, corners, ratio, skew });

            function cleanup() {
              src.delete();
              gray.delete();
              blurred.delete();
              edges.delete();
              contours.delete();
              hierarchy.delete();
              if (bestApprox) bestApprox.delete();
            }
          } catch (e) {
            console.error(e);
            resolve({ ok: false });
          }
        });
      }

      function getDocumentRatio(corners, wImg, hImg) {
        if (corners.length < 4) return 0;

        let xs = corners.map((c) => c.x);
        let ys = corners.map((c) => c.y);

        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);

        const w = maxX - minX;
        const h = maxY - minY;

        return h / w;
      }

      function getDocumentSkew(corners) {
        if (corners.length < 2) return 99;
        const tl = corners[0];
        const tr = corners[1];

        const dx = tr.x - tl.x;
        const dy = tr.y - tl.y;

        return (Math.atan2(dy, dx) * 180) / Math.PI;
      }

      /* ================= STABILITY DETECTOR ================= */
      function isStable(canvas) {
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

        if (!lastFrameData) {
          lastFrameData = frame;
          return false;
        }

        let diff = 0;
        for (let i = 0; i < frame.length; i += 20) {
          diff += Math.abs(frame[i] - lastFrameData[i]);
        }

        lastFrameData = frame;

        return diff < 500000;
      }

      /* ================= HAND DETECTOR (rough) ================= */
      function detectHand(canvas) {
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

        let skin = 0;
        const total = canvas.width * canvas.height;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i],
            g = data[i + 1],
            b = data[i + 2];

          if (
            r > 95 &&
            g > 40 &&
            b > 20 &&
            r > g &&
            r > b &&
            Math.abs(r - g) > 15
          ) {
            skin++;
          }
        }

        const ratio = skin / total;
        return ratio > 0.12;
      }

      /* ================= PREVIEW ================= */
      function renderImages() {
        previewEl.innerHTML = "";

        images.forEach((img, i) => {
          previewEl.innerHTML += `
        <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
          <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
          <button data-i="${i}"
                  class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">ðŸ—‘</button>
        </div>
      `;
        });

        document.querySelectorAll("button[data-i]").forEach((btn) => {
          btn.onclick = () => {
            const idx = btn.dataset.i;
            URL.revokeObjectURL(images[idx].url);
            images.splice(idx, 1);
            renderImages();
          };
        });
      }
    </script>
  </body>
</html>
