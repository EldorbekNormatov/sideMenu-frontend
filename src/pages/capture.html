<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">

    <div class="max-w-md mx-auto p-4">

      <h2 class="text-xl font-bold mb-4">Rasmga olish</h2>

      <div class="flex gap-3 mb-3">
        <button id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition">
          ðŸ“¸ Kamerani ochish
        </button>

        <button id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition">
          ðŸ’¾ Yuborish
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px]"></p>

      <div id="camera-box" class="hidden mt-4">
        <video id="video" autoplay playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover"></video>

        <button id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition">
          ðŸ“· Rasmni olish
        </button>
      </div>

      <h3 class="mt-6 font-bold text-sm">Olingan rasmlar</h3>
      <div id="preview" class="space-y-2 mt-2"></div>

    </div>

<script>
let stream = null;
let images = [];

const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");

function setStatus(t){ statusEl.textContent = t; }

/* ================= CAMERA ================= */
document.getElementById("startBtn").onclick = async () => {
  try {
    setStatus("Kamera ochilmoqda...");

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    document.getElementById("video").srcObject = stream;
    document.getElementById("camera-box").classList.remove("hidden");

    setStatus("Rasmga olish mumkin.");
  } catch (e) {
    setStatus("âŒ Kamera ochilmadi");
  }
};

/* ================= CAPTURE ================= */
document.getElementById("captureBtn").onclick = async () => {
  const video = document.getElementById("video");
  if (!video.videoWidth) return setStatus("Kamera tayyor emas");

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d", { willReadFrequently:true });
  ctx.drawImage(video, 0, 0);

  setStatus("Tekshirilmoqda...");

  const blurry = await isBlur(canvas);
  const lighting = await isLightingBad(canvas);

  if (blurry) return setStatus("âŒ Rasm xira (fokus qiling)");
  if (lighting === "dark") return setStatus("âŒ Juda qorongâ€˜i");
  if (lighting === "bright") return setStatus("âŒ Juda yorugâ€˜");

  const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.9));
  const url = URL.createObjectURL(blob);

  images.push({ blob, url });
  renderImages();

  saveBtn.classList.remove("hidden");
  setStatus("Rasm saqlandi");
};

/* ================= BLUR DETECTOR ================= */
async function isBlur(canvas, threshold = 70){
  return new Promise(res=>{
    const scale = 200 / Math.max(canvas.width, canvas.height);
    const w = canvas.width * scale;
    const h = canvas.height * scale;

    const c = document.createElement("canvas");
    c.width = w; c.height = h;

    const ctx = c.getContext("2d",{willReadFrequently:true});
    ctx.drawImage(canvas,0,0,w,h);

    const {data} = ctx.getImageData(0,0,w,h);

    let sum=0, sq=0;
    for(let i=0;i<data.length;i+=4){
      const g=(data[i]+data[i+1]+data[i+2])/3;
      sum+=g; sq+=g*g;
    }

    const n=data.length/4;
    const variance = sq/n - (sum/n)**2;

    res(variance < threshold);
  });
}

/* ================= LIGHTING DETECTOR ================= */
async function isLightingBad(canvas){
  const ctx = canvas.getContext("2d",{willReadFrequently:true});
  const {data} = ctx.getImageData(0,0,canvas.width,canvas.height);

  let sum=0,n=data.length/4;

  for(let i=0;i<data.length;i+=4){
    const b=(data[i]+data[i+1]+data[i+2])/3;
    sum+=b;
  }

  const avg=sum/n;

  if(avg<50) return "dark";
  if(avg>210) return "bright";
  return "ok";
}

/* ================= PREVIEW ================= */
function renderImages(){
  previewEl.innerHTML="";

  images.forEach((img,i)=>{
    previewEl.innerHTML += `
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
        <button data-i="${i}" class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">ðŸ—‘</button>
      </div>
    `;
  });

  // Delete handler
  previewEl.querySelectorAll("button").forEach(btn=>{
    btn.onclick=()=>{
      images.splice(btn.dataset.i,1);
      renderImages();
    };
  });
}

</script>

</body>
</html>
