<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- OpenCV.js AI uchun -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-md mx-auto p-4">
      <h2 class="text-xl font-bold mb-4">Hujjatni rasmga olish</h2>

      <!-- START + SAVE BUTTONS -->
      <div class="flex gap-3 mb-3">
        <button id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition">
          üì∏ Kamerani ochish
        </button>

        <button id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition">
          üíæ Hamma rasmlarni yuborish
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

      <!-- CAMERA BOX -->
      <div id="camera-box" class="hidden mt-4 relative">

        <!-- FLASH STATUS OVERLAY -->
        <div id="flashOnScreen"
          class="absolute top-3 right-3 bg-yellow-500 px-3 py-1 rounded-full text-xs hidden z-20">
          üî¶ Flash
        </div>

        <!-- STABILIZATION / DOC STATUS OVERLAY (AI tekst) -->
        <div id="infoOverlay"
          class="absolute left-1/2 -translate-x-1/2 bottom-3 bg-slate-900/70 px-3 py-1 rounded-full text-xs z-20">
        </div>

        <!-- VIDEO -->
        <video id="video" autoplay playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover relative z-0"></video>

        <!-- AI RECTANGLE OVERLAY -->
        <canvas id="overlay"
          class="absolute inset-0 w-full h-full pointer-events-none z-10"></canvas>

        <!-- FLASH TOGGLE BUTTON ICHKARIDA -->
        <button id="flashBtn"
          class="absolute bottom-20 right-3 bg-yellow-600 p-2 rounded-full hidden active:scale-95 transition text-sm z-20">
          üî¶
        </button>

        <!-- CAPTURE BUTTON -->
        <button id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition relative z-20">
          üì∑ Rasmni olish
        </button>
      </div>

      <!-- PREVIEW -->
      <h3 class="mt-6 font-bold text-sm">Qabul qilingan rasmlar</h3>
      <div id="preview" class="space-y-2 mt-2"></div>
    </div>

<script>
/* ===========================
   URL ‚Üí UID ‚Üí LOCALSTORAGE
=========================== */
const params = new URLSearchParams(window.location.search);
const uidFromUrl = params.get("uid");

if (uidFromUrl) {
  localStorage.setItem("driver_uid", uidFromUrl);
}

const DRIVER_UID = localStorage.getItem("driver_uid") || "";
const API = "https://panel.nvmailer.uz";

let stream = null;
let images = [];
let videoTrack = null;
let torchOn = false;

let cvReady = false;
let lastQuad = null;       // Hujjatning oxirgi aniqlangan to‚Äòrtburchagi
let lastCenter = null;     // Markaz (stabilization uchun)
let isShaky = false;       // Telefon qimirlayaptimi yo‚Äòqmi

const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");
const overlayCanvas = document.getElementById("overlay");
const overlayCtx = overlayCanvas.getContext("2d");
const infoOverlay = document.getElementById("infoOverlay");

/* OpenCV tayyor bo‚Äòlishini kutish */
(function waitForCV() {
  const check = setInterval(() => {
    if (window.cv && cv && cv.Mat) {
      cv['onRuntimeInitialized'] = () => {
        cvReady = true;
      };
      clearInterval(check);
    }
  }, 100);
})();

/* ===========================
      STATUS
=========================== */
function setStatus(text, color="yellow") {
  statusEl.textContent = text;
  statusEl.className =
    color === "green" ? "text-green-400 text-xs" :
    color === "red" ? "text-red-400 text-xs" :
    "text-yellow-300 text-xs";
}

/* ===========================
      INFO OVER VIDEO
=========================== */
function setInfo(text) {
  infoOverlay.textContent = text || "";
}

/* ===========================
      FLASH ON/OFF BUTTON
=========================== */
async function toggleTorch() {
  if (!videoTrack) return;
  const caps = videoTrack.getCapabilities?.();
  if (!caps || !caps.torch) return;

  torchOn = !torchOn;

  try {
    await videoTrack.applyConstraints({
      advanced: [{ torch: torchOn }]
    });

    document.getElementById("flashBtn").textContent = torchOn ? "üî¶" : "üîÜ";

    const flash = document.getElementById("flashOnScreen");
    flash.classList.remove("hidden");
    flash.textContent = torchOn ? "üî• Flash YOQILDI" : "üí§ Flash O‚ÄòCHDI";
    setTimeout(() => flash.classList.add("hidden"), 800);
  } catch (err) {
    console.error(err);
    setStatus("Torch ishlamadi", "red");
  }
}

/* ===========================
    FLASH BURST (1 SONIYA)
=========================== */
async function flashBurst() {
  if (!videoTrack) return;
  const caps = videoTrack.getCapabilities?.();
  if (!caps || !caps.torch) return;

  const flash = document.getElementById("flashOnScreen");

  try {
    await videoTrack.applyConstraints({ advanced: [{ torch: true }] });
    flash.textContent = "‚ö° FLASH!";
    flash.classList.remove("hidden");

    await new Promise(res => setTimeout(res, 1000)); // 1 soniya yonadi

    await videoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
    flash.classList.add("hidden");
  } catch (err) {
    console.error(err);
  }
}

/* ===========================
   Hujjat nuqtalarini tartiblash
=========================== */
function orderQuad(pts) {
  // pts: [{x,y}, ...]
  const sum = pts.map(p => p.x + p.y);
  const diff = pts.map(p => p.y - p.x);

  const tl = pts[sum.indexOf(Math.min(...sum))];
  const br = pts[sum.indexOf(Math.max(...sum))];
  const tr = pts[diff.indexOf(Math.min(...diff))];
  const bl = pts[diff.indexOf(Math.max(...diff))];

  return [tl, tr, br, bl];
}

/* ===========================
      AI DETECTION LOOP
=========================== */
function startDetectionLoop() {
  if (!stream) return;

  const video = document.getElementById("video");
  const detectCanvas = document.createElement("canvas");
  const dctx = detectCanvas.getContext("2d");

  function step() {
    if (!stream) return;

    if (!cvReady || !video.videoWidth || !video.videoHeight) {
      requestAnimationFrame(step);
      return;
    }

    const w = video.videoWidth;
    const h = video.videoHeight;

    detectCanvas.width = w;
    detectCanvas.height = h;
    overlayCanvas.width = w;
    overlayCanvas.height = h;

    dctx.drawImage(video, 0, 0, w, h);

    let src = new cv.Mat();
    let gray = new cv.Mat();
    let blur = new cv.Mat();
    let edges = new cv.Mat();
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();

    cv.imshow(detectCanvas, src); // Bu ishlamaydi, to'g'rilaymiz:
    // To'g'ri: src = cv.imread(detectCanvas);
    src = cv.imread(detectCanvas);

    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
    cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);
    cv.Canny(blur, edges, 75, 200);

    cv.findContours(edges, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);

    let bestArea = 0;
    let bestQuad = null;

    for (let i = 0; i < contours.size(); i++) {
      let cnt = contours.get(i);
      let peri = cv.arcLength(cnt, true);
      let approx = new cv.Mat();
      cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

      if (approx.rows === 4) {
        let area = cv.contourArea(approx);
        if (area > bestArea) {
          bestArea = area;
          if (bestQuad) bestQuad.delete();
          bestQuad = approx;
        } else {
          approx.delete();
        }
      } else {
        approx.delete();
      }
      cnt.delete();
    }

    overlayCtx.clearRect(0, 0, w, h);

    if (bestQuad && bestArea > w * h * 0.15) {
      let points = [];
      // approx data32S: [x0,y0,x1,y1,x2,y2,x3,y3]
      for (let i = 0; i < 4; i++) {
        const x = bestQuad.intAt(i, 0);
        const y = bestQuad.intAt(i, 1);
        points.push({ x, y });
      }

      const ordered = orderQuad(points);
      lastQuad = ordered;

      // Stabilization: markaz harakatini tekshirish
      const cx = (ordered[0].x + ordered[1].x + ordered[2].x + ordered[3].x) / 4;
      const cy = (ordered[0].y + ordered[1].y + ordered[2].y + ordered[3].y) / 4;

      if (lastCenter) {
        const dx = cx - lastCenter.x;
        const dy = cy - lastCenter.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        isShaky = dist > 10; // threshold (10px dan katta harakat bo‚Äòlsa titrayapti deb hisoblanadi)
      } else {
        isShaky = false;
      }
      lastCenter = { x: cx, y: cy };

      // Hujjat chegarasini chizish
      overlayCtx.beginPath();
      overlayCtx.moveTo(ordered[0].x, ordered[0].y);
      for (let i = 1; i < 4; i++) {
        overlayCtx.lineTo(ordered[i].x, ordered[i].y);
      }
      overlayCtx.closePath();
      overlayCtx.lineWidth = 3;
      overlayCtx.strokeStyle = "rgba(16, 185, 129, 0.95)"; // emerald-500
      overlayCtx.stroke();

      // Burchaklarni belgilab qo‚Äòyish
      overlayCtx.fillStyle = "rgba(16, 185, 129, 0.95)";
      ordered.forEach(p => {
        overlayCtx.beginPath();
        overlayCtx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
        overlayCtx.fill();
      });

      if (isShaky) {
        setInfo("üì≥ Telefoni qimirlatmay turing");
      } else {
        setInfo("üìÑ Hujjat aniqlandi. Rasmga olish mumkin.");
      }
    } else {
      lastQuad = null;
      isShaky = false;
      setInfo("Hujjatni kamerada to‚Äòliq ko‚Äòrinadigan qiling");
    }

    src.delete(); gray.delete(); blur.delete(); edges.delete();
    contours.delete(); hierarchy.delete();
    if (bestQuad) bestQuad.delete();

    requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

/* ===========================
      KAMERA OCHISH
=========================== */
document.getElementById("startBtn").onclick = async () => {
  try {
    setStatus("Kamera ochilmoqda...");

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        focusMode: "continuous"
      }
    });

    videoTrack = stream.getVideoTracks()[0];
    const caps = videoTrack.getCapabilities?.() || {};

    // Autofocus
    if (caps.focusMode) {
      videoTrack.applyConstraints({
        advanced: [{ focusMode: "continuous" }]
      }).catch(() => {});
    }

    // Torch tugmasi ko‚Äòrinishi
    if (caps.torch) {
      document.getElementById("flashBtn").classList.remove("hidden");
    }

    const video = document.getElementById("video");
    video.srcObject = stream;
    document.getElementById("camera-box").classList.remove("hidden");

    setStatus("Kamera tayyor. Hujjatni kameraga joylashtiring.", "green");
    setInfo("Hujjatni kameraga to‚Äòliq tushiring");

    // AI detection loop
    startDetectionLoop();

  } catch (e) {
    console.error(e);
    setStatus("‚ùå Kamera ochilmadi", "red");
  }
};

document.getElementById("flashBtn").onclick = toggleTorch;

/* ===========================
   CAPTURE ‚Üí /photo-check
=========================== */
document.getElementById("captureBtn").onclick = async () => {
  const video = document.getElementById("video");
  if (!video.videoWidth) return setStatus("Kamera tayyor emas", "red");

  if (isShaky) {
    setStatus("üì≥ Avval telefonni tinch tuting", "red");
    return;
  }

  // FLASH 1 SONIYA
  await flashBurst();

  const baseCanvas = document.createElement("canvas");
  baseCanvas.width = video.videoWidth;
  baseCanvas.height = video.videoHeight;
  const bctx = baseCanvas.getContext("2d");
  bctx.drawImage(video, 0, 0, baseCanvas.width, baseCanvas.height);

  let finalCanvas = baseCanvas;

  // Agar hujjat aniq topilgan bo‚Äòlsa ‚Üí auto-crop
  if (cvReady && lastQuad) {
    try {
      const ordered = lastQuad;
      // Width/heightni aniqlash
      const widthTop = Math.hypot(
        ordered[1].x - ordered[0].x,
        ordered[1].y - ordered[0].y
      );
      const widthBottom = Math.hypot(
        ordered[2].x - ordered[3].x,
        ordered[2].y - ordered[3].y
      );
      const maxWidth = Math.max(widthTop, widthBottom);

      const heightLeft = Math.hypot(
        ordered[3].x - ordered[0].x,
        ordered[3].y - ordered[0].y
      );
      const heightRight = Math.hypot(
        ordered[2].x - ordered[1].x,
        ordered[2].y - ordered[1].y
      );
      const maxHeight = Math.max(heightLeft, heightRight);

      const dstW = Math.round(maxWidth);
      const dstH = Math.round(maxHeight);

      const src = cv.imread(baseCanvas);
      const dst = new cv.Mat();

      const srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
        ordered[0].x, ordered[0].y,
        ordered[1].x, ordered[1].y,
        ordered[2].x, ordered[2].y,
        ordered[3].x, ordered[3].y
      ]);

      const dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
        0, 0,
        dstW, 0,
        dstW, dstH,
        0, dstH
      ]);

      const M = cv.getPerspectiveTransform(srcTri, dstTri);
      const dsize = new cv.Size(dstW, dstH);
      cv.warpPerspective(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());

      finalCanvas = document.createElement("canvas");
      finalCanvas.width = dstW;
      finalCanvas.height = dstH;
      cv.imshow(finalCanvas, dst);

      src.delete(); dst.delete(); srcTri.delete(); dstTri.delete(); M.delete();
      setStatus("Hujjat auto-crop qilindi", "green");
    } catch (err) {
      console.error("Auto-crop xato:", err);
    }
  }

  setStatus("Rasm serverga yuborilyapti...");

  const blob = await new Promise(res =>
    finalCanvas.toBlob(res, "image/jpeg", 0.9)
  );

  const form = new FormData();
  form.append("photo", blob, "photo.jpg");
  form.append("uid", DRIVER_UID);

  try {
    const resp = await fetch(`${API}/photo-check`, { method: "POST", body: form });
    const data = await resp.json();
    console.log("photo-check:", data);

    if (!data.ok) {
      setStatus(data.msg || "‚ùå Rasm yaroqsiz", "red");
      return;
    }

    const url = URL.createObjectURL(blob);
    images.push({ blob, url });

    renderImages();
    saveBtn.classList.remove("hidden");

    setStatus("‚úî Rasm qabul qilindi! Keyingisini oling.", "green");
  } catch (err) {
    console.error(err);
    setStatus("‚ùå Server bilan aloqa yo‚Äòq", "red");
  }
};

/* ===========================
      PREVIEW RASMLAR
=========================== */
function renderImages() {
  previewEl.innerHTML = "";

  images.forEach((img, i) => {
    previewEl.innerHTML += `
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
        <button data-i="${i}" class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">
          üóë O'chirish
        </button>
      </div>
    `;
  });

  document.querySelectorAll("button[data-i]").forEach(btn => {
    btn.onclick = () => {
      images.splice(btn.dataset.i, 1);
      renderImages();
      if (images.length === 0) saveBtn.classList.add("hidden");
    };
  });
}

/* ===========================
   ALL PHOTOS ‚Üí /photo-save
=========================== */
saveBtn.onclick = async () => {
  if (images.length === 0)
    return setStatus("Avval kamida bitta rasm oling", "red");

  setStatus("Hamma rasmlar yuborilyapti...");

  const form = new FormData();
  images.forEach((img, i) => {
    form.append("photos", img.blob, `photo_${i}.jpg`);
  });

  form.append("uid", DRIVER_UID);

  try {
    const resp = await fetch(`${API}/photo-save`, { method: "POST", body: form });
    const data = await resp.json();
    console.log("photo-save:", data);

    if (data.ok) {
      setStatus("‚úî Hamma rasm yuborildi!", "green");
      images = [];
      renderImages();
      saveBtn.classList.add("hidden");
    } else {
      setStatus(data.msg || "‚ùå Yuborishda xatolik", "red");
    }
  } catch (e) {
    console.error(e);
    setStatus("‚ùå Server bilan aloqa yo‚Äòq", "red");
  }
};
</script>

  </body>
</html>
