<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">

    <div class="max-w-md mx-auto p-4">

      <h2 class="text-xl font-bold mb-4">Hujjatni rasmga olish</h2>

      <!-- BUTTONS -->
      <div class="flex gap-3 mb-3">
        <button id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition">
          ðŸ“¸ Kamerani ochish
        </button>

        <button id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition">
          ðŸ’¾ Yuborish
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

      <!-- CAMERA -->
      <div id="camera-box" class="hidden mt-4">
        <video id="video" autoplay playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover"></video>

        <button id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition">
          ðŸ“· Rasmni olish
        </button>
      </div>

      <!-- PREVIEW -->
      <h3 class="mt-6 font-bold text-sm">Olingan rasmlar</h3>
      <div id="preview" class="space-y-2 mt-2"></div>

    </div>

<script>
let stream = null;
let images = [];

const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");

function setStatus(text, color="yellow") {
  statusEl.textContent = text;
  statusEl.classList.remove("text-red-400","text-green-400","text-yellow-300");

  if(color === "red") statusEl.classList.add("text-red-400");
  else if(color === "green") statusEl.classList.add("text-green-400");
  else statusEl.classList.add("text-yellow-300");
}

/* ========================================================
    CAMERA START
======================================================== */
document.getElementById("startBtn").onclick = async () => {
  try {
    setStatus("Kamera ochilmoqda...");

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    document.getElementById("video").srcObject = stream;
    document.getElementById("camera-box").classList.remove("hidden");

    setStatus("Kamera tayyor. Rasmga oling.", "green");
  } catch (e) {
    setStatus("âŒ Kamera ochilmadi", "red");
  }
};

/* ========================================================
    CAPTURE + QUALITY CHECK
======================================================== */
document.getElementById("captureBtn").onclick = async () => {
  const video = document.getElementById("video");
  if (!video.videoWidth) return setStatus("Kamera tayyor emas", "red");

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d", { willReadFrequently:true });
  ctx.drawImage(video, 0, 0);

  setStatus("Tekshirilmoqda...");

  // BLUR TEST
  const blurry = await isBlur(canvas);
  if (blurry) return setStatus("âŒ Rasm xira (fokus qiling)", "red");

  // LIGHTING TEST
  const lighting = await isLightingBad(canvas);
  if (lighting === "dark") return setStatus("âŒ Juda qorongâ€˜i", "red");
  if (lighting === "bright") return setStatus("âŒ Juda yorugâ€˜", "red");

  // DOCUMENT FULL VISIBILITY TEST
  const docOK = await isDocumentFullyVisible(canvas);
  if (!docOK)
    return setStatus("âŒ Hujjat toâ€˜liq kadrga sigâ€˜madi. Telefonni bir oz uzoqroqqa oling.", "red");

  // SAVE IMAGE
  const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.9));
  const url = URL.createObjectURL(blob);

  images.push({ blob, url });
  renderImages();

  saveBtn.classList.remove("hidden");
  setStatus("Rasm saqlandi", "green");
};

/* ========================================================
    BLUR DETECTOR (variance)
======================================================== */
async function isBlur(canvas, threshold = 70){
  return new Promise(res=>{
    const scale = 200 / Math.max(canvas.width, canvas.height);
    const w = canvas.width * scale;
    const h = canvas.height * scale;

    const c = document.createElement("canvas");
    c.width = w; c.height = h;

    const ctx = c.getContext("2d",{willReadFrequently:true});
    ctx.drawImage(canvas,0,0,w,h);

    const {data} = ctx.getImageData(0,0,w,h);

    let sum=0, sq=0;
    for(let i=0;i<data.length;i+=4){
      const g=(data[i]+data[i+1]+data[i+2])/3;
      sum += g;
      sq += g * g;
    }

    const n=data.length/4;
    const variance = sq/n - (sum/n)**2;

    res(variance < threshold);
  });
}

/* ========================================================
    LIGHTING DETECTOR
======================================================== */
async function isLightingBad(canvas){
  const ctx = canvas.getContext("2d",{willReadFrequently:true});
  const {data} = ctx.getImageData(0,0,canvas.width,canvas.height);

  let sum=0,n=data.length/4;

  for(let i=0;i<data.length;i+=4){
    const b=(data[i]+data[i+1]+data[i+2])/3;
    sum+=b;
  }

  const avg=sum/n;

  if(avg < 50) return "dark";
  if(avg > 210) return "bright";
  return "ok";
}

/* ========================================================
    DOCUMENT FULL VISIBILITY DETECTOR
======================================================== */
async function isDocumentFullyVisible(canvas){
  return new Promise((resolve)=>{
    const ctx = canvas.getContext("2d",{willReadFrequently:true});
    const {width, height} = canvas;

    const img = ctx.getImageData(0, 0, width, height).data;

    let brightPixels = 0;
    let totalPixels = width * height;

    let left = 99999, right=-1, top=99999, bottom=-1;

    for(let i=0;i<img.length;i+=4){
      const r=img[i], g=img[i+1], b=img[i+2];
      const bright = (r+g+b)/3;

      if(bright > 150){  // oq-ish qogâ€˜oz maydoni
        brightPixels++;

        const idx=i/4;
        const x=idx % width;
        const y=Math.floor(idx/width);

        if(x<left) left=x;
        if(x>right) right=x;
        if(y<top) top=y;
        if(y>bottom) bottom=y;
      }
    }

    const brightRatio = brightPixels / totalPixels;

    // Hujjat oq maydon yetarli boâ€˜lishi kerak
    if(brightRatio < 0.10) return resolve(false);  
    if(brightRatio > 0.85) return resolve(false);  

    const docW = right - left;
    const docH = bottom - top;
    const docArea = docW * docH;
    const areaRatio = docArea / totalPixels;

    // Hujjat koâ€˜p qismi kadrda boâ€˜lishi kerak
    if(areaRatio < 0.25) return resolve(false);
    if(areaRatio > 0.90) return resolve(false);

    // Hujjat shakli A4 ga yaqin
    const ratio = docH / docW;
    if(ratio < 0.8 || ratio > 1.8) return resolve(false);

    resolve(true);
  });
}

/* ========================================================
    PREVIEW RENDERS
======================================================== */
function renderImages(){
  previewEl.innerHTML = "";

  images.forEach((img,i)=>{
    previewEl.innerHTML += `
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
        <button data-i="${i}"
                class="ml-auto px-2 py-1 bg-red-600 rounded-full text-xs">ðŸ—‘</button>
      </div>
    `;
  });

  document.querySelectorAll("button[data-i]").forEach(btn=>{
    btn.onclick=()=>{
      images.splice(btn.dataset.i, 1);
      renderImages();
    };
  });
}

</script>
</body>
</html>
