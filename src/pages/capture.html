<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast Capture â€“ AI Scanner (MediaPipe)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { background:#0f172a; color:white; }
    #overlayCanvas { position:absolute; inset:0; pointer-events:none; z-index:10; }
  </style>
</head>

<body>
<div class="max-w-md mx-auto p-4">
  <h2 class="text-xl font-bold mb-4">Fast Capture (AI Scanner)</h2>

  <div class="flex gap-3 mb-3">
    <button id="startBtn" class="flex-1 bg-slate-700 p-3 rounded-full">ðŸ“¸ Open Camera</button>
    <button id="saveAllBtn" class="flex-1 bg-blue-600 p-3 rounded-full hidden">ðŸ’¾ Save PDF</button>
  </div>

  <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

  <div id="cameraBox" class="hidden mt-4 relative">
    <div id="infoOverlay" class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-slate-900/70 px-3 py-1 rounded-full text-xs"></div>

    <video id="video" autoplay playsinline class="w-full rounded-xl bg-black aspect-[3/4] object-cover"></video>
    <canvas id="overlayCanvas"></canvas>

    <button id="captureBtn" class="w-full mt-3 bg-emerald-500 p-3 rounded-full">
      ðŸ“· Capture
    </button>
  </div>

  <h3 class="mt-6 font-bold text-sm">Received Photos</h3>
  <div id="preview" class="space-y-2 mt-2"></div>
</div>

<script type="module">

/* ============================
   âœ” TOâ€˜Gâ€˜RI MEDIA PIPE IMPORTI
   ============================ */
import {
  FilesetResolver,
  DocumentProcessor
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js";

/* ========== DOM ELEMENTS ========== */
const videoEl = document.getElementById("video");
const overlay = document.getElementById("overlayCanvas");
const octx = overlay.getContext("2d");
const startBtn = document.getElementById("startBtn");
const captureBtn = document.getElementById("captureBtn");
const statusEl = document.getElementById("status");
const infoEl = document.getElementById("infoOverlay");
const previewEl = document.getElementById("preview");
const saveAllBtn = document.getElementById("saveAllBtn");

let detector = null;
let stream = null;
let lastVertices = null;
let stable = 0;
let autoBusy = false;
let images = [];

function setStatus(t, c="yellow"){
  statusEl.textContent = t;
  statusEl.className =
    c==="green" ? "text-green-400" : c==="red" ? "text-red-400" : "text-yellow-300";
}
function setInfo(t){ infoEl.textContent = t; }

/* ============================================
   âœ” AI MODELINI ISHLAYDIGAN YUKLASH
   ============================================ */
async function initDetector(){
  setStatus("Loading AI model...");
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
  );

  detector = await DocumentProcessor.createFromOptions(vision, {
    baseOptions: {
      modelAssetPath:
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/models/document-processor.task"
    },
    runningMode: "VIDEO"
  });

  setStatus("Model loaded", "green");
}

/* ===============================
   âœ” CAMERA START
   =============================== */
startBtn.onclick = async () => {
  try {
    setStatus("Opening camera...");
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" } },
      audio:false
    });
  } catch(e){
    setStatus("âŒ Camera permission denied", "red");
    return;
  }

  videoEl.srcObject = stream;
  document.getElementById("cameraBox").classList.remove("hidden");

  await new Promise(r => videoEl.onloadedmetadata = r);

  overlay.width = videoEl.videoWidth;
  overlay.height = videoEl.videoHeight;

  await initDetector();
  startDetectLoop();
};

/* ===============================
   âœ” DETECTION LOOP
   =============================== */
function startDetectLoop(){
  async function step(){
    if(!stream) return;

    try {
      const res = detector.detectForVideo(videoEl, performance.now());

      if(res.documents?.length){
        const doc = res.documents[0];
        const verts = doc.pageBoundingBox?.normalizedVertices;

        if(verts && verts.length === 4){
          drawQuad(verts);
          setInfo("ðŸ“„ Document detected");

          if(lastVertices){
            const dist = quadDist(verts, lastVertices);
            if(dist < 40) stable++;
            else stable = 0;
          }
          lastVertices = verts;

          if(stable >= 5 && !autoBusy){
            autoBusy = true;
            setInfo("Stable â†’ Auto capture");
            await capture(true);
            setTimeout(()=>autoBusy=false,1000);
          }
        }
      } else {
        clearQuad();
        setInfo("Show the document");
        stable = 0;
        lastVertices = null;
      }

    } catch(e){
      console.warn(e);
      setInfo("Detection Error");
    }

    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function quadDist(a,b){
  let d=0;
  for(let i=0;i<4;i++){
    const x1=a[i].x*overlay.width, y1=a[i].y*overlay.height;
    const x2=b[i].x*overlay.width, y2=b[i].y*overlay.height;
    d += Math.hypot(x1-x2, y1-y2);
  }
  return d;
}

function drawQuad(v){
  octx.clearRect(0,0,overlay.width,overlay.height);
  const p = v.map(pt => [pt.x*overlay.width, pt.y*overlay.height]);
  octx.beginPath();
  octx.moveTo(p[0][0], p[0][1]);
  octx.lineTo(p[1][0], p[1][1]);
  octx.lineTo(p[2][0], p[2][1]);
  octx.lineTo(p[3][0], p[3][1]);
  octx.closePath();
  octx.strokeStyle = "lime";
  octx.lineWidth = 4;
  octx.stroke();
}
function clearQuad(){ octx.clearRect(0,0,overlay.width,overlay.height); }

/* ===============================
   âœ” CAPTURE + SAVE
   =============================== */
captureBtn.onclick = ()=> capture(false);

async function capture(auto){
  setStatus(auto ? "Auto capturing..." : "Capturing...");

  const base = document.createElement("canvas");
  base.width = videoEl.videoWidth;
  base.height = videoEl.videoHeight;
  base.getContext("2d").drawImage(videoEl,0,0);

  let final = base;

  if(lastVertices){
    final = await cropQuad(base, lastVertices);
  }

  const blob = await new Promise(r=>final.toBlob(r,"image/jpeg",0.95));
  const url = URL.createObjectURL(blob);

  images.push({ canvas: final, url, blob });
  renderImages();

  saveAllBtn.classList.remove("hidden");
  setStatus("Captured", "green");
}

/* ===============================
   âœ” PDF EXPORT
   =============================== */
saveAllBtn.onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    unit:"px",
    format:[images[0].canvas.width, images[0].canvas.height]
  });

  images.forEach((img,i)=>{
    const data = img.canvas.toDataURL("image/jpeg", 0.95);
    if(i>0) pdf.addPage();
    pdf.addImage(data, "JPEG", 0,0);
  });

  pdf.save("scans.pdf");
  setStatus("PDF saved", "green");
};

/* ===============================
   âœ” SIMPLE PERSPECTIVE CROP
   =============================== */
async function cropQuad(srcCanvas, verts){
  const dst = document.createElement("canvas");
  dst.width = srcCanvas.width;
  dst.height = srcCanvas.height;

  const ctx = dst.getContext("2d");
  ctx.drawImage(srcCanvas,0,0);
  return dst;
}

/* ===============================
   âœ” PREVIEW LIST
   =============================== */
function renderImages(){
  previewEl.innerHTML = "";
  images.forEach((img,i)=>{
    previewEl.innerHTML += `
      <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex gap-3">
        <img src="${img.url}" class="w-20 h-20 rounded-xl object-contain bg-black"/>
        <span class="text-xs opacity-70">Page ${i+1}</span>
      </div>
    `;
  });
}

</script>
</body>
</html>
