<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fast Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- OpenCV.js for AI -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-md mx-auto p-4">
      <h2 class="text-xl font-bold mb-4">Take Document Photo</h2>

      <!-- START + SAVE BUTTONS -->
      <div class="flex gap-3 mb-3">
        <button id="startBtn"
          class="flex-1 bg-slate-700 p-3 rounded-full active:scale-95 transition">
          üì∏ Open Camera
        </button>

        <button id="saveBtn"
          class="flex-1 bg-blue-600 p-3 rounded-full hidden active:scale-95 transition">
          üíæ Download PDF
        </button>
      </div>

      <p id="status" class="text-xs min-h-[20px] text-yellow-300"></p>

      <!-- CAMERA BOX -->
      <div id="camera-box" class="hidden mt-4 relative">

        <!-- FLASH STATUS OVERLAY (faqat UI) -->
        <div id="flashOnScreen"
          class="absolute top-3 right-3 bg-yellow-500 px-3 py-1 rounded-full text-xs hidden z-20">
          üî¶ Flash
        </div>

        <!-- AI / STATUS OVERLAY -->
        <div id="infoOverlay"
          class="absolute left-1/2 -translate-x-1/2 bottom-3 bg-slate-900/70 px-3 py-1 rounded-full text-xs z-20">
        </div>

        <!-- VIDEO STREAM -->
        <video id="video" autoplay playsinline
          class="w-full rounded-xl bg-black aspect-[3/4] object-cover relative z-0"></video>

        <!-- AI BOUNDING BOX -->
        <canvas id="overlay"
          class="absolute inset-0 w-full h-full pointer-events-none z-10"></canvas>

        <!-- CAPTURE BUTTON -->
        <button id="captureBtn"
          class="w-full mt-3 bg-emerald-500 p-3 rounded-full active:scale-95 transition relative z-20">
          üì∑ Capture Photo
        </button>
      </div>

      <!-- FILTER MODE -->
      <div class="mt-4 text-xs flex items-center gap-2">
        <span class="opacity-70">Filter:</span>
        <select id="filterMode"
          class="bg-slate-800 border border-slate-700 text-xs rounded-full px-3 py-1">
          <option value="auto">Auto (CamScanner style)</option>
          <option value="color">Magic Color</option>
          <option value="gray">Gray</option>
          <option value="bw">Black & White</option>
          <option value="none">Original</option>
        </select>
      </div>

      <!-- PREVIEW -->
      <h3 class="mt-6 font-bold text-sm">Received Photos</h3>
      <div id="preview" class="space-y-2 mt-2"></div>
    </div>

<script>
/* ==========================
      GLOBAL VARIABLES
========================== */
let stream = null;
let images = [];      // {blob, url}
let videoTrack = null;
let cvReady = false;
let lastQuad = null;

let prevQuad = null;
let stableCount = 0;
let autoCooldown = false;

/* ==========================
      DOM
========================== */
const previewEl = document.getElementById("preview");
const saveBtn = document.getElementById("saveBtn");
const overlayCanvas = document.getElementById("overlay");
const overlayCtx = overlayCanvas.getContext("2d");
const infoOverlay = document.getElementById("infoOverlay");
const statusEl = document.getElementById("status");
const filterModeEl = document.getElementById("filterMode");

function setInfo(t){ infoOverlay.textContent = t }
function setStatus(t){ statusEl.textContent = t }

/* ==========================
      WAIT FOR OpenCV
========================== */
function waitForCVReady() {
  return new Promise(resolve => {
    function check() {
      if (window.cv && typeof cv.Mat === "function") {
        cvReady = true;
        resolve();
      } else {
        requestAnimationFrame(check);
      }
    }
    check();
  });
}

/* ==========================
      HIGH RES CAMERA
========================== */
document.getElementById("startBtn").onclick = async () => {
  setStatus("‚è≥ Loading AI & camera...");
  await waitForCVReady();

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width:  { ideal: 1920 },   // 1080p ‚Äì real telefonlarda yetarli
        height: { ideal: 1080 }
      }
    });
  } catch (e) {
    console.error(e);
    setStatus("‚ùå Camera permission denied.");
    return;
  }

  videoTrack = stream.getVideoTracks()[0];
  document.getElementById("video").srcObject = stream;
  document.getElementById("camera-box").classList.remove("hidden");

  setStatus("‚úÖ Camera ready. Hold document inside frame.");
  startDetectionLoop();
};

/* ==========================
      QUAD STABILITY
========================== */
function isSameQuad(q1, q2) {
  if (!q1 || !q2) return false;
  let d = 0;
  for (let i = 0; i < 4; i++)
    d += Math.hypot(q1[i].x - q2[i].x, q1[i].y - q2[i].y);
  return d < 15; // sezgirlikni oshirdik
}

/* ==========================
      QUAD SORT (TL,TR,BR,BL)
========================== */
function sortCorners(pts) {
  // chap/yuqori bo‚Äòyicha taxmin
  pts.sort((a,b) => (a.y - b.y) || (a.x - b.x));
  const top = pts.slice(0,2).sort((a,b)=>a.x-b.x);
  const bottom = pts.slice(2,4).sort((a,b)=>a.x-b.x);
  return [top[0], top[1], bottom[1], bottom[0]]; // TL,TR,BR,BL
}

/* ==========================
      AUTO CAPTURE
========================== */
async function autoCapture() {
  if (autoCooldown) return;
  autoCooldown = true;

  overlayCanvas.style.boxShadow = "0 0 35px 10px lime";

  setTimeout(() => {
    overlayCanvas.style.boxShadow = "none";
  }, 400);

  document.getElementById("captureBtn").click();

  setTimeout(() => autoCooldown = false, 1300);
}

/* ==========================
      BLUR / SHARPNESS CHECK
========================== */
function isFrameSharp(grayMat) {
  let lap = new cv.Mat();
  cv.Laplacian(grayMat, lap, cv.CV_64F);
  const data = lap.data64F;
  let mean = 0;
  for (let i = 0; i < data.length; i++) mean += Math.abs(data[i]);
  mean /= data.length;
  lap.delete();
  return mean > 8; // tajribaviy threshold
}

/* ==========================
      SUPER DETECTION LOOP
========================== */
function startDetectionLoop() {
  const video = document.getElementById("video");
  const temp = document.createElement("canvas");
  const ctx = temp.getContext("2d");

  function step() {
    if (!stream || !video.videoWidth) {
      requestAnimationFrame(step);
      return;
    }

    const w = video.videoWidth;
    const h = video.videoHeight;

    temp.width = w;
    temp.height = h;
    overlayCanvas.width = w;
    overlayCanvas.height = h;

    ctx.drawImage(video, 0, 0, w, h);

    let src = cv.imread(temp);
    let gray = new cv.Mat();
    let blur = new cv.Mat();
    let edges = new cv.Mat();
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();

    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, blur, new cv.Size(7,7), 0);
    cv.Canny(blur, edges, 50, 150);

    cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    overlayCtx.clearRect(0,0,w,h);

    let best = null;
    let maxArea = 0;

    for (let i = 0; i < contours.size(); i++) {
      let cnt = contours.get(i);
      let peri = cv.arcLength(cnt, true);
      let approx = new cv.Mat();

      cv.approxPolyDP(cnt, approx, peri * 0.03, true);

      if (approx.rows === 4) {
        let area = cv.contourArea(cnt);
        if (area > maxArea) {
          maxArea = area;
          best = approx;
        }
      } else {
        approx.delete();
      }
      cnt.delete();
    }

    if (best && maxArea > (w*h*0.15)) {
      let pts = [];
      for (let i = 0; i < 4; i++)
        pts.push({ x: best.intAt(i,0), y: best.intAt(i,1) });

      pts = sortCorners(pts);
      lastQuad = pts;

      overlayCtx.beginPath();
      overlayCtx.moveTo(pts[0].x, pts[0].y);
      overlayCtx.lineTo(pts[1].x, pts[1].y);
      overlayCtx.lineTo(pts[2].x, pts[2].y);
      overlayCtx.lineTo(pts[3].x, pts[3].y);
      overlayCtx.closePath();
      overlayCtx.lineWidth = 4;
      overlayCtx.strokeStyle = "lime";
      overlayCtx.shadowColor = "lime";
      overlayCtx.shadowBlur = 18;
      overlayCtx.stroke();

      const sharp = isFrameSharp(gray);
      if (!sharp) {
        setInfo("üîç Hold still ‚Äì image is blurry");
        stableCount = 0;
      } else {
        setInfo("üìÑ Document detected ‚Äì keep still...");
        if (isSameQuad(prevQuad, pts)) stableCount++;
        else stableCount = 0;

        prevQuad = pts;

        if (stableCount > 10) autoCapture();
      }
    }
    else {
      lastQuad = null;
      prevQuad = null;
      stableCount = 0;
      setInfo("Searching document...");
    }

    src.delete(); gray.delete(); blur.delete();
    edges.delete(); contours.delete(); hierarchy.delete();

    requestAnimationFrame(step);
  }
  step();
}

/* ==========================
      SCANNER FILTERS
========================== */
function applyFilter(dst, mode) {
  if (mode === "none") return dst;

  if (mode === "gray") {
    cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY);
    cv.equalizeHist(dst, dst);
    return dst;
  }

  if (mode === "bw") {
    cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY);
    cv.adaptiveThreshold(
      dst, dst, 255,
      cv.ADAPTIVE_THRESH_GAUSSIAN_C,
      cv.THRESH_BINARY,
      25,
      8
    );
    return dst;
  }

  if (mode === "color") {
    cv.cvtColor(dst, dst, cv.COLOR_RGBA2RGB);
    cv.detailEnhance(dst, dst, 10, 0.15);
    return dst;
  }

  // auto: hujjat oq fon + qora matn bo‚Äòlsa B/W, aks holda magic color
  let tmp = new cv.Mat();
  cv.cvtColor(dst, tmp, cv.COLOR_RGBA2GRAY);
  let hist = new cv.Mat();
  cv.calcHist(tmp, [0], new cv.Mat(), hist, [64], [0,256]);
  // juda qo‚Äòpol auto heuristika
  let bright = 0;
  for (let i = 40; i < 64; i++) bright += hist.data32F[i] || 0;
  hist.delete();
  if (bright > tmp.rows * tmp.cols * 0.4) {
    // B/W hujjat
    tmp.delete();
    return applyFilter(dst, "bw");
  } else {
    tmp.delete();
    return applyFilter(dst, "color");
  }
}

/* ==========================
      CAPTURE HQ + SCAN FILTER
========================== */
document.getElementById("captureBtn").onclick = async () => {
  if (!stream) return;
  const video = document.getElementById("video");

  const track = stream.getVideoTracks()[0];
  const settings = track.getSettings();
  const realW = settings.width || video.videoWidth;
  const realH = settings.height || video.videoHeight;

  const base = document.createElement("canvas");
  base.width = realW;
  base.height = realH;
  base.getContext("2d").drawImage(video, 0, 0, realW, realH);

  let finalCanvas = base;

  if (lastQuad) {
    let pts = lastQuad;

    let src = cv.imread(base);
    let dst = new cv.Mat();

    let srcTri = cv.matFromArray(4,1,cv.CV_32FC2,[
      pts[0].x,pts[0].y,
      pts[1].x,pts[1].y,
      pts[2].x,pts[2].y,
      pts[3].x,pts[3].y
    ]);

    let w1 = Math.hypot(pts[1].x-pts[0].x, pts[1].y-pts[0].y);
    let w2 = Math.hypot(pts[2].x-pts[3].x, pts[2].y-pts[3].y);
    let h1 = Math.hypot(pts[3].x-pts[0].x, pts[3].y-pts[0].y);
    let h2 = Math.hypot(pts[2].x-pts[1].x, pts[2].y-pts[1].y);

    let dstW = Math.max(w1, w2);
    let dstH = Math.max(h1, h2);

    let dstTri = cv.matFromArray(4,1,cv.CV_32FC2,[
      0,0, dstW,0, dstW,dstH, 0,dstH
    ]);

    let M = cv.getPerspectiveTransform(srcTri, dstTri);
    cv.warpPerspective(src, dst, M, new cv.Size(dstW, dstH));

    // CamScanner style filter
    applyFilter(dst, filterModeEl.value);

    finalCanvas = document.createElement("canvas");
    finalCanvas.width = dst.cols;
    finalCanvas.height = dst.rows;
    cv.imshow(finalCanvas, dst);

    src.delete(); dst.delete(); srcTri.delete(); dstTri.delete(); M.delete();
  }

  const blob = await new Promise(r => finalCanvas.toBlob(b => r(b), "image/jpeg", 0.9));
  const url = URL.createObjectURL(blob);

  images.push({ blob, url });
  renderImages();
  saveBtn.classList.remove("hidden");
  setStatus(`üìÑ Added page ${images.length}.`);
};

/* ==========================
      PREVIEW LIST
========================== */
function renderImages() {
  previewEl.innerHTML = "";
  images.forEach((img, i) => {
    previewEl.innerHTML += `
    <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-3">
      <div class="relative">
        <img src="${img.url}" class="w-20 h-20 rounded-lg object-cover"/>
        <span class="absolute -top-2 -left-2 bg-slate-900 text-[10px] px-1.5 rounded-full">#${i+1}</span>
      </div>
      <button class="ml-auto bg-red-600 text-xs rounded-full px-2 py-1"
              onclick="images.splice(${i},1); renderImages(); if(images.length===0) saveBtn.classList.add('hidden');">
        üóë Delete
      </button>
    </div>`;
  });
}

/* ==========================
      BLOB ‚Üí DATAURL
========================== */
function blobToDataUrl(blob) {
  return new Promise(res => {
    const reader = new FileReader();
    reader.onloadend = () => res(reader.result);
    reader.readAsDataURL(blob);
  });
}

/* ==========================
      DOWNLOAD PDF (CamScanner style)
========================== */
saveBtn.onclick = async () => {
  if (!images.length) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "mm", format: "a4" });

  for (let i = 0; i < images.length; i++) {
    if (i > 0) pdf.addPage();
    const dataUrl = await blobToDataUrl(images[i].blob);

    // A4: 210 √ó 297 mm, margin 5mm
    const pageW = 210;
    const pageH = 297;
    const margin = 5;

    // rasm nisbatini saqlab joylashtirish
    const img = new Image();
    img.src = dataUrl;
    await new Promise(r => img.onload = r);
    const imgRatio = img.width / img.height;
    let w = pageW - margin * 2;
    let h = w / imgRatio;
    if (h > pageH - margin * 2) {
      h = pageH - margin * 2;
      w = h * imgRatio;
    }
    const x = (pageW - w) / 2;
    const y = (pageH - h) / 2;

    pdf.addImage(dataUrl, "JPEG", x, y, w, h);
  }

  pdf.save("scan.pdf");
  setStatus("‚úÖ PDF downloaded.");
};

</script>
</body>
</html>
